name: Flutter Signed Release APK (arm64-v8a)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: false

      # ðŸ” DEBUG: Proje yapÄ±sÄ±nÄ± kontrol et
      - name: Proje yapÄ±sÄ±nÄ± kontrol et
        run: |
          echo "=== PROJE YAPISI ==="
          echo "Mevcut dizin: $(pwd)"
          echo ""
          echo "=== TÃ¼m dosyalar ==="
          find . -maxdepth 3 -type f -name "*.html" -o -name "*.dart" -o -name "*.yaml" | head -20
          echo ""
          echo "=== assets/ klasÃ¶rÃ¼ ==="
          ls -la assets/ 2>/dev/null || echo "assets/ klasÃ¶rÃ¼ bulunamadÄ±"
          echo ""
          echo "=== assets/web/ varsa ==="
          ls -la assets/web/ 2>/dev/null || echo "assets/web/ bulunamadÄ±"

      # ðŸ“ Asset dosyalarÄ±nÄ± pubspec.yaml'a ekle (geliÅŸtirilmiÅŸ)
      - name: pubspec.yaml -> TÃ¼m asset'leri ekle
        run: |
          echo "=== pubspec.yaml ORJÄ°NAL ==="
          cat pubspec.yaml
          echo ""
          
          # pubspec.yaml'Ä± yedekle
          cp pubspec.yaml pubspec.yaml.backup
          
          # flutter: bÃ¶lÃ¼mÃ¼nÃ¼ temizle
          sed -i '/^flutter:/,/^[^ ]/d' pubspec.yaml
          
          # Yeni flutter bÃ¶lÃ¼mÃ¼ ekle
          echo "" >> pubspec.yaml
          echo "flutter:" >> pubspec.yaml
          echo "  uses-material-design: true" >> pubspec.yaml
          echo "" >> pubspec.yaml
          echo "  assets:" >> pubspec.yaml
          
          # TÃ¼m asset dosyalarÄ±nÄ± bul ve ekle
          echo "    - assets/web/index.html" >> pubspec.yaml
          
          # TÃ¼m alt klasÃ¶rler iÃ§in joker karakter kullan
          if [ -d "assets/web/images" ]; then
            echo "    - assets/web/images/" >> pubspec.yaml
          fi
          
          if [ -d "assets/web/fonts" ]; then
            echo "    - assets/web/fonts/" >> pubspec.yaml
          fi
          
          if [ -d "assets/build" ]; then
            echo "    - assets/build/" >> pubspec.yaml
          fi
          
          # TÃ¼m web klasÃ¶rÃ¼ndeki dosyalar
          find assets/web -type f -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" -o -name "*.json" 2>/dev/null | head -20 | while read file; do
            echo "    - $file" >> pubspec.yaml
          done
          
          echo "" >> pubspec.yaml
          echo "=== pubspec.yaml GÃœNCELLENMÄ°Åž ==="
          cat pubspec.yaml

      # ðŸ› DEBUG: Asset'leri test et
      - name: Asset'leri test et
        run: |
          echo "=== ASSET TEST ==="
          
          # Test iÃ§in basit bir index.html oluÅŸtur (eÄŸer yoksa)
          if [ ! -f "assets/web/index.html" ]; then
            echo "âš ï¸ assets/web/index.html bulunamadÄ±, oluÅŸturuluyor..."
            mkdir -p assets/web
            cat > assets/web/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“„ PDF Reader - GITHUB ACTIONS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        h1 { font-size: 2.5rem; margin-bottom: 20px; }
        .success { 
            background: rgba(255,255,255,0.2); 
            padding: 30px; 
            border-radius: 15px;
            margin: 20px;
        }
        .big-check { font-size: 4rem; color: #4CAF50; }
    </style>
</head>
<body>
    <div class="success">
        <div class="big-check">âœ…</div>
        <h1>GITHUB ACTIONS BUILD</h1>
        <p>Bu sayfa GitHub Actions tarafÄ±ndan oluÅŸturuldu.</p>
        <p>Build zamanÄ±: <span id="time"></span></p>
        <p>Flutter InAppWebView v6.1.5 Ã§alÄ±ÅŸÄ±yor.</p>
    </div>
    <script>
        document.getElementById('time').textContent = new Date().toLocaleString();
        console.log('âœ… GitHub Actions build successful!');
    </script>
</body>
</html>
EOF
            echo "âœ… assets/web/index.html oluÅŸturuldu"
          fi
          
          echo ""
          echo "=== OluÅŸturulan HTML ==="
          head -20 assets/web/index.html

      - name: Keystore yaz
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore/release.keystore

      - name: key.properties yaz
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=keystore/release.keystore
          EOF

      # ðŸ“¦ Paketleri indir ve kontrol et
      - name: Paketleri indir ve kontrol et
        run: |
          echo "=== flutter pub get ==="
          flutter pub get
          
          echo ""
          echo "=== flutter_inappwebview versiyonu ==="
          grep -A2 -B2 flutter_inappwebview pubspec.yaml
          grep -A2 -B2 flutter_inappwebview pubspec.lock 2>/dev/null || echo "pubspec.lock henÃ¼z yok"
          
          echo ""
          echo "=== flutter doctor ==="
          flutter doctor -v | grep -A5 "Flutter"

      # ðŸ—ï¸ Build yap ve log'larÄ± kaydet
      - name: Signed Release APK build (arm64-v8a) - DETAILED
        run: |
          echo "=== flutter build apk --verbose ==="
          flutter build apk --release --target-platform android-arm64 --verbose 2>&1 | tail -100
          
          # Build baÅŸarÄ±lÄ± mÄ± kontrol et
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ…âœ…âœ… APK BAÅžARIYLA OLUÅžTURULDU! âœ…âœ…âœ…"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âŒâŒâŒ APK OLUÅžTURULAMADI! âŒâŒâŒ"
            echo "Build klasÃ¶rÃ¼ iÃ§eriÄŸi:"
            find build/ -type f -name "*.apk" 2>/dev/null || echo "APK bulunamadÄ±"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: pdfreader-release-arm64-v8a
          path: build/app/outputs/flutter-apk/app-release.apk
          
      # ðŸ“Š Build log'larÄ±nÄ± da kaydet
      - name: Build log'larÄ±nÄ± kaydet
        if: always()
        run: |
          echo "=== BUILD SONUÃ‡LARI ==="
          echo "Workflow sonucu: ${{ job.status }}"
          echo ""
          echo "OluÅŸturulan dosyalar:"
          find build/ -type f -name "*.apk" -o -name "*.aab" 2>/dev/null | while read file; do
            echo "- $file ($(stat -c%s "$file") bytes)"
          done
