name: Flutter Signed Release APK (arm64-v8a)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: false

      # ğŸ” DEBUG: Proje yapÄ±sÄ±nÄ± kontrol et
      - name: Proje yapÄ±sÄ±nÄ± kontrol et
        run: |
          echo "=== PROJE YAPISI ==="
          echo "Mevcut dizin: $(pwd)"
          echo ""
          echo "=== TÃ¼m dosyalar ==="
          find . -maxdepth 3 -type f \( -name "*.html" -o -name "*.dart" -o -name "*.yaml" \) | head -20
          echo ""
          echo "=== assets/ klasÃ¶rÃ¼ ==="
          ls -la assets/ 2>/dev/null || echo "assets/ klasÃ¶rÃ¼ bulunamadÄ±"
          echo ""
          echo "=== assets/web/ varsa ==="
          ls -la assets/web/ 2>/dev/null || echo "assets/web/ bulunamadÄ±"

      # ğŸ“ Asset dosyalarÄ±nÄ± pubspec.yaml'a ekle
      - name: pubspec.yaml asset'leri dÃ¼zenle
        run: |
          echo "=== pubspec.yaml ORJÄ°NAL ==="
          cat pubspec.yaml
          echo ""
          
          # Yeni pubspec.yaml oluÅŸtur
          cat > pubspec.yaml << 'EOF'
name: pdfreader
description: "PDF Reader"
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: ^3.10.4

dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.8
  flutter_inappwebview: ^6.1.5

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^6.0.0

flutter:
  uses-material-design: true

  assets:
    - assets/web/index.html
    - assets/web/
    - assets/build/
EOF
          
          echo "=== pubspec.yaml GÃœNCELLENMÄ°Å ==="
          cat pubspec.yaml

      # ğŸ› DEBUG: Asset'leri test et
      - name: Asset'leri test et
        run: |
          echo "=== ASSET TEST ==="
          
          # Test iÃ§in basit bir index.html oluÅŸtur (eÄŸer yoksa)
          if [ ! -f "assets/web/index.html" ]; then
            echo "âš ï¸ assets/web/index.html bulunamadÄ±, oluÅŸturuluyor..."
            mkdir -p assets/web
            cat > assets/web/index.html << 'HTML_EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“„ PDF Reader - GITHUB ACTIONS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        h1 { font-size: 2.5rem; margin-bottom: 20px; }
        .success { 
            background: rgba(255,255,255,0.2); 
            padding: 30px; 
            border-radius: 15px;
            margin: 20px;
        }
        .big-check { font-size: 4rem; color: #4CAF50; }
    </style>
</head>
<body>
    <div class="success">
        <div class="big-check">âœ…</div>
        <h1>GITHUB ACTIONS BUILD</h1>
        <p>Bu sayfa GitHub Actions tarafÄ±ndan oluÅŸturuldu.</p>
        <p>Build zamanÄ±: <span id="time"></span></p>
        <p>Flutter InAppWebView v6.1.5 Ã§alÄ±ÅŸÄ±yor.</p>
    </div>
    <script>
        document.getElementById('time').textContent = new Date().toLocaleString();
        console.log('âœ… GitHub Actions build successful!');
    </script>
</body>
</html>
HTML_EOF
            echo "âœ… assets/web/index.html oluÅŸturuldu"
          fi
          
          echo ""
          echo "=== OluÅŸturulan HTML ==="
          head -20 assets/web/index.html

      - name: Keystore yaz
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore/release.keystore

      - name: key.properties yaz
        run: |
          cat << 'PROPERTIES_EOF' > android/key.properties
storePassword=${{ secrets.KEYSTORE_PASSWORD }}
keyPassword=${{ secrets.KEY_PASSWORD }}
keyAlias=${{ secrets.KEY_ALIAS }}
storeFile=keystore/release.keystore
PROPERTIES_EOF

      # ğŸ“¦ Paketleri indir ve kontrol et
      - name: Paketleri indir ve kontrol et
        run: |
          echo "=== flutter pub get ==="
          flutter pub get
          
          echo ""
          echo "=== flutter_inappwebview versiyonu ==="
          grep -A2 -B2 flutter_inappwebview pubspec.yaml
          
          echo ""
          echo "=== flutter doctor ==="
          flutter doctor

      # ğŸ—ï¸ Build yap
      - name: Signed Release APK build (arm64-v8a)
        run: |
          echo "=== flutter build apk ==="
          flutter build apk --release --target-platform android-arm64
          
          # Build baÅŸarÄ±lÄ± mÄ± kontrol et
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ…âœ…âœ… APK BAÅARIYLA OLUÅTURULDU! âœ…âœ…âœ…"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âŒâŒâŒ APK OLUÅTURULAMADI! âŒâŒâŒ"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: pdfreader-release-arm64-v8a
          path: build/app/outputs/flutter-apk/app-release.apk
