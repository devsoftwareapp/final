<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PDF Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
  margin: 0;
  background: #000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  height: 100vh;
  overflow: hidden;
}

#topbar {
  height: 56px;
  background: #1e1e1e;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  position: relative;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

#topbar .material-icons {
  color: #ffffff;
  font-size: 24px;
  cursor: pointer;
  transition: opacity 0.2s;
}

#topbar .material-icons:hover {
  opacity: 0.8;
}

#backBtn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  transition: background-color 0.2s;
}

#backBtn:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

#title {
  flex: 1;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #ffffff;
  font-size: 18px;
  font-weight: 500;
  padding: 0 8px;
}

.topbar-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.topbar-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  transition: background-color 0.2s;
  position: relative;
}

.topbar-action-btn:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.topbar-action-btn .material-icons {
  color: #ffffff;
}

iframe {
  width: 100%;
  height: calc(100vh - 56px);
  border: none;
  display: block;
}

/* Loading State */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  color: white;
  font-size: 16px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #ffffff;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toast Notification */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: #323232;
  color: white;
  padding: 12px 24px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 500;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 1001;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Media query for smaller screens */
@media (max-width: 480px) {
  #topbar {
    height: 48px;
    padding: 0 12px;
    gap: 12px;
  }
  
  #topbar .material-icons {
    font-size: 22px;
  }
  
  #title {
    font-size: 16px;
  }
  
  iframe {
    height: calc(100vh - 48px);
  }
}

/* Light mode support */
body.light-mode {
  background: #f5f5f5;
}

body.light-mode #topbar {
  background: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

body.light-mode #topbar .material-icons {
  color: #333333;
}

body.light-mode #backBtn:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

body.light-mode .topbar-action-btn:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

body.light-mode #title {
  color: #333333;
}

body.light-mode .loading-overlay {
  background: rgba(255, 255, 255, 0.9);
  color: #333333;
}

body.light-mode .loading-spinner {
  border: 3px solid rgba(0, 0, 0, 0.1);
  border-top-color: #333333;
}

body.light-mode .toast {
  background: #424242;
  color: white;
}
</style>
</head>

<body>

<div id="topbar">
  <div id="backBtn" onclick="goBack()">
    <span class="material-icons">arrow_back</span>
  </div>
  
  <div id="title">PDF</div>
  
  <div class="topbar-actions">
    <div class="topbar-action-btn" id="shareBtn" title="Paylaş">
      <span class="material-icons">share</span>
    </div>
    <div class="topbar-action-btn" id="printBtn" title="Yazdır">
      <span class="material-icons">print</span>
    </div>
    <div class="topbar-action-btn" id="saveBtn" title="Kaydet">
      <span class="material-icons">save</span>
    </div>
  </div>
</div>

<iframe id="viewerFrame"></iframe>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div>PDF yükleniyor...</div>
</div>

<div class="toast" id="toast"></div>

<script>
const iframe = document.getElementById("viewerFrame");
const title = document.getElementById("title");
const loadingOverlay = document.getElementById("loadingOverlay");
const toast = document.getElementById("toast");

// Tema uygula
function applyTheme() {
  const selectedTheme = localStorage.getItem('selectedTheme') || 'device';
  
  // Önce tüm tema sınıflarını kaldır
  document.body.classList.remove('dark-mode', 'light-mode');
  
  if (selectedTheme === 'device') {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.add('light-mode');
    }
  } else if (selectedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  } else if (selectedTheme === 'light') {
    document.body.classList.add('light-mode');
  }
}

// Sayfa yüklendiğinde temayı uygula
applyTheme();

// Sistem teması değiştiğinde dinle
if (window.matchMedia) {
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  mediaQuery.addEventListener('change', () => {
    const selectedTheme = localStorage.getItem('selectedTheme') || 'device';
    if (selectedTheme === 'device') {
      applyTheme();
    }
  });
}

// PDF yükleme durumu
let pdfReady = false;

// Toast mesajı göster
function showToast(message, duration = 3000) {
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// Geri butonu
function goBack() {
  if (typeof flutterHandler !== 'undefined' && flutterHandler.goBack) {
    flutterHandler.goBack();
  } else {
    window.history.back();
  }
}

// PDF görüntüleyiciyi başlat
function initializePDFViewer() {
  console.log('initializePDFViewer called');
  
  // Tarayıcıda: sessionStorage'dan al
  // Flutter WebView'de: window.pdfViewerData'dan al
  let pdfData, pdfName;
  
  if (typeof window.pdfViewerData !== 'undefined') {
    // Flutter WebView modu
    pdfData = window.pdfViewerData.pdfData;
    pdfName = window.pdfViewerData.pdfName;
    console.log('Using Flutter WebView data, PDF name:', pdfName, 'Data length:', pdfData?.length);
  } else if (sessionStorage.getItem('pdfData')) {
    // Tarayıcı modu - sessionStorage
    pdfData = sessionStorage.getItem('pdfData');
    pdfName = sessionStorage.getItem('pdfName');
    console.log('Using sessionStorage data, PDF name:', pdfName, 'Data length:', pdfData?.length);
  } else if (localStorage.getItem('pdfData')) {
    // Fallback: localStorage
    pdfData = localStorage.getItem('pdfData');
    pdfName = localStorage.getItem('pdfName');
    console.log('Using localStorage data, PDF name:', pdfName, 'Data length:', pdfData?.length);
  } else {
    console.error('No PDF data found in any source');
    showToast('PDF verisi bulunamadı', 3000);
    setTimeout(() => {
      goBack();
    }, 2000);
    return;
  }

  // PDF adını göster
  if (pdfName) {
    title.textContent = pdfName;
  }

  if (!pdfData || pdfData.trim() === '') {
    console.error('PDF data is empty or null');
    showToast('PDF verisi boş veya geçersiz', 3000);
    setTimeout(() => {
      goBack();
    }, 2000);
    return;
  }

  console.log('Loading viewer.html with PDF data');
  iframe.src = "viewer.html";

  iframe.onload = () => {
    console.log('viewer.html loaded, sending PDF data');
    
    // PDF verisini iframe'e gönder
    try {
      iframe.contentWindow.postMessage(
        { 
          type: "pdfData", 
          base64: pdfData, 
          name: pdfName 
        },
        "*"
      );
      console.log('PDF data sent to viewer');
    } catch (error) {
      console.error('Error sending PDF data:', error);
      showToast('PDF verisi gönderilemedi', 3000);
    }
    
    // Yükleme overlay'ini gizle
    setTimeout(() => {
      loadingOverlay.style.display = 'none';
    }, 1000);
  };

  iframe.onerror = (error) => {
    console.error('iframe load error:', error);
    showToast('PDF görüntüleyici yüklenirken hata oluştu', 3000);
    loadingOverlay.innerHTML = `
      <div style="color: #ff6b6b; font-size: 48px; margin-bottom: 16px;">
        <span class="material-icons">error</span>
      </div>
      <div style="text-align: center; margin-bottom: 16px;">PDF görüntüleyici yüklenemedi</div>
      <button onclick="goBack()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
        Geri Dön
      </button>
    `;
  };
}

// PDF hazır olduğunda mesaj dinleyici
window.addEventListener("message", e => {
  console.log('Received message:', e.data?.type);
  
  if (e.data?.type === "pdf-ready") {
    pdfReady = true;
    console.log('PDF is ready');
    showToast('PDF hazır', 1500);
  }
  
  if (e.data?.type === "pdf-error") {
    console.error('PDF error:', e.data.message);
    showToast('PDF yüklenirken hata oluştu: ' + e.data.message, 4000);
    loadingOverlay.style.display = 'flex';
  }
});

// PDF uygulamasını al
function getApp() {
  return iframe.contentWindow?.PDFViewerApplication;
}

// Son PDF blob'unu al
async function getFinalBlob() {
  const app = getApp();
  if (!app) {
    console.error('PDFViewerApplication not found');
    return null;
  }

  try {
    console.log('Getting final PDF blob...');
    
    // PDF render'ını zorla
    await app.pdfViewer.forceRendering();
    
    // Annotation'ları kaydet
    try {
      await app.pdfDocument.annotationStorage.flush();
      console.log('Annotations flushed');
    } catch (err) {
      console.log("Annotation kaydetme hatası:", err);
    }

    // PDF verisini al
    console.log('Saving document...');
    const data = await app.pdfDocument.saveDocument(
      app.pdfDocument.annotationStorage
    );
    
    console.log('PDF blob created, size:', data?.byteLength || 0);
    return new Blob([data], { type: "application/pdf" });
  } catch (error) {
    console.error("PDF blob oluşturma hatası:", error);
    showToast('PDF işlenirken hata oluştu', 3000);
    return null;
  }
}

/* YAZDIR */
document.getElementById("printBtn").onclick = async () => {
  console.log('Print button clicked');
  
  if (!pdfReady) {
    showToast('PDF yükleniyor...', 2000);
    return;
  }

  const blob = await getFinalBlob();
  if (!blob) {
    showToast('PDF oluşturulamadı', 3000);
    return;
  }

  console.log('Creating print window...');
  const url = URL.createObjectURL(blob);
  
  // Gizli iframe oluştur
  const printFrame = document.createElement("iframe");
  printFrame.style.display = "none";
  printFrame.src = url;
  document.body.appendChild(printFrame);

  printFrame.onload = () => {
    console.log('Print frame loaded, printing...');
    try {
      printFrame.contentWindow.print();
      showToast('Yazdırma başlatıldı', 2000);
    } catch (err) {
      console.error('Print error:', err);
      showToast('Yazdırma başlatılamadı', 3000);
    }
    
    setTimeout(() => {
      URL.revokeObjectURL(url);
      printFrame.remove();
      console.log('Print resources cleaned up');
    }, 2000);
  };
  
  printFrame.onerror = (error) => {
    console.error('Print frame error:', error);
    showToast('PDF yazdırma için açılamadı', 3000);
    URL.revokeObjectURL(url);
    printFrame.remove();
  };
};

/* PAYLAŞ */
document.getElementById("shareBtn").onclick = async () => {
  console.log('Share button clicked');
  
  if (!pdfReady) {
    showToast('PDF yükleniyor...', 2000);
    return;
  }

  const blob = await getFinalBlob();
  if (!blob) {
    showToast('PDF oluşturulamadı', 3000);
    return;
  }

  const fileName = title.textContent || "document.pdf";
  const file = new File([blob], fileName, { type: "application/pdf" });
  console.log('File created for sharing:', fileName, 'size:', blob.size);

  // Web Share API kontrolü
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      console.log('Using Web Share API...');
      await navigator.share({ 
        files: [file],
        title: fileName,
        text: 'PDF dosyası'
      });
      showToast('PDF paylaşıldı', 2000);
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Share error:', error);
        showToast('Paylaşım başarısız oldu', 3000);
      }
    }
  } else {
    console.log('Web Share API not available, downloading instead...');
    // Alternatif: dosya indirme
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    setTimeout(() => {
      URL.revokeObjectURL(url);
    }, 100);
    
    showToast('PDF indiriliyor...', 2000);
  }
};

/* KAYDET */
document.getElementById("saveBtn").onclick = async () => {
  console.log('Save button clicked');
  
  if (!pdfReady) {
    showToast('PDF yükleniyor...', 2000);
    return;
  }

  const blob = await getFinalBlob();
  if (!blob) {
    showToast('PDF oluşturulamadı', 3000);
    return;
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const fileName = title.textContent || "document.pdf";

  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  setTimeout(() => {
    URL.revokeObjectURL(url);
  }, 1500);
  
  showToast('PDF kaydedildi', 2000);
  console.log('PDF saved:', fileName);
};

// Sayfa yüklendiğinde PDF görüntüleyiciyi başlat
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOMContentLoaded, checking for PDF data...');
  
  // window.pdfViewerData varsa hemen başlat
  if (typeof window.pdfViewerData !== 'undefined') {
    console.log('window.pdfViewerData found, initializing...');
    initializePDFViewer();
  } else {
    // Tarayıcı modu için kısa bir delay
    setTimeout(() => {
      console.log('Checking storage for PDF data...');
      if (sessionStorage.getItem('pdfData') || localStorage.getItem('pdfData')) {
        initializePDFViewer();
      } else {
        console.log('No PDF data found, waiting for external initialization...');
        // Dışarıdan initializePDFViewer çağrılacak
      }
    }, 100);
  }
});

// Flutter ile iletişim için global fonksiyonlar
window.flutterHandler = {
  goBack: function() {
    console.log('flutterHandler.goBack called');
    if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
      window.flutter_inappwebview.callHandler('goBack');
    }
  },
  saveFile: function(fileName, base64Data) {
    console.log('flutterHandler.saveFile called:', fileName);
    if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
      window.flutter_inappwebview.callHandler('saveFile', fileName, base64Data);
    }
  },
  shareFile: function(fileName, base64Data) {
    console.log('flutterHandler.shareFile called:', fileName);
    if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
      window.flutter_inappwebview.callHandler('shareFile', fileName, base64Data);
    }
  },
  showToast: function(message) {
    console.log('flutterHandler.showToast called:', message);
    if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
      window.flutter_inappwebview.callHandler('showToast', message);
    }
  }
};

// Klavye kısayolları
document.addEventListener('keydown', (e) => {
  // Escape tuşu ile geri git
  if (e.key === 'Escape') {
    goBack();
  }
  
  // Ctrl/Cmd + P ile yazdır
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    document.getElementById("printBtn").click();
  }
  
  // Ctrl/Cmd + S ile kaydet
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    document.getElementById("saveBtn").click();
  }
});
</script>

</body>
</html>
