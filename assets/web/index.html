<!doctype html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PDF Reader | Dev Software</title>
  
  
  
  <script>
    // --- BURAYA YAPIÅžTIRIN ---
    function initTheme() {
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const themeToSet = systemPrefersDark ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', themeToSet);
    }

    // Dinleyiciyi de hemen altÄ±na ekleyin
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const newTheme = e.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        if (typeof loadData === "function") loadData(); 
    });

    // Sayfa yÃ¼klenir yÃ¼klenmez Ã§alÄ±ÅŸtÄ±rÄ±n
    initTheme();
    // -------------------------
</script>

  
  
  
  
  <style>
  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }

  /* Material Symbols Rounded - Local WebView Font */
  @font-face {
      font-family: 'Material Symbols Rounded';
      src: url('fonts/MaterialSymbolsRounded.woff2') format('woff2');
      font-weight: 100 700;
      font-style: normal;
  }

  .material-symbols-rounded {
      font-family: 'Material Symbols Rounded';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      display: inline-block;
      line-height: 1;
      text-transform: none;
      letter-spacing: normal;
      word-wrap: normal;
      white-space: nowrap;
      direction: ltr;
      -webkit-font-smoothing: antialiased;
      font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 48;
  }
  
  /* --- 1. DEÄžÄ°ÅžKENLER --- */
  :root {
    --background: #e8e8e8;
    --surface: #e8e8e8;
    --primary: #E53935;
    --secondary: #B71C1C;
    --success: #4cc9f0;
    --error: #f94144;
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --border: #d4d4d4; 
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --transition-fast: 150ms ease;
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    
    --header-height: 64px;
    --tabs-height: 60px;
    --top-bar-total: 124px;
    --bottom-nav-height: 72px;
    
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-full: 9999px;
    
    --z-content: 1;
    --z-top-bar: 100;
    --z-bottom-nav: 100;
    --z-overlay: 2000;
    --z-context-menu: 2100;
    --z-permission-modal: 2200;
    
    --card-icon-size: 36px;
    --card-padding: 10px;
    --card-gutter: 12px;
    --card-max-width: 500px;
    
    --pdf-color-main: #E53935;
    --pdf-color-bg: #E53935; 
    --pdf-color-text: #E53935; 
    
    --selection-bg: rgba(229, 57, 53, 0.1);
    --selection-border: #E53935;
  }

  [data-theme="dark"] {
    --background: #0f172a;
    --surface: #1e293b;
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
    --border: #334155;
    --pdf-color-bg: #FF6961; 
    --pdf-color-text: #B71C1C; 
    --selection-bg: rgba(255, 105, 97, 0.15);
    --selection-border: #FF6961;
  }

  /* --- 2. TEMEL AYARLAR --- */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { 
    height: 100%; 
    font-family: 'Roboto', sans-serif; 
    background-color: var(--background); 
    color: var(--text-primary); 
    overflow: hidden; 
    /* âœ… Safe-area uyumluluÄŸu */
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bottom);
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
  }
  body { 
    display: flex; 
    flex-direction: column; 
    padding-top: 0; /* Body padding'i component'lere daÄŸÄ±tÄ±yoruz */
  }
  .material-symbols-rounded { 
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
    user-select: none; 
  }
  .flex { display: flex; }
  .items-center { align-items: center; }
  .gap-sm { gap: var(--spacing-sm); }
  .font-semibold { font-weight: 600; }
  .text-secondary { color: var(--text-secondary); }
  .text-sm { font-size: 14px; }
  .justify-between { justify-content: space-between; }
  .flex-col { flex-direction: column; }
  .mt-2 { margin-top: 8px; }
  .mt-3 { margin-top: 12px; }
  .mb-2 { margin-bottom: 8px; }
  .text-center { text-align: center; }

  /* --- PERMISSION MODAL STYLES --- */
  .permission-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: var(--z-permission-modal);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    /* âœ… Safe-area desteÄŸi */
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bottom);
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
  }
  
  .permission-modal-overlay.show {
    opacity: 1;
    visibility: visible;
  }
  
  .permission-modal {
    background: var(--surface);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 400px;
    padding: 32px 24px 24px 24px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    border: 1px solid var(--border);
  }
  
  .permission-modal-overlay.show .permission-modal {
    transform: translateY(0);
  }
  
  .permission-modal-icon {
    width: 80px;
    height: 80px;
    background: rgba(229, 57, 53, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px auto;
  }
  
  .permission-modal-icon .material-symbols-rounded {
    font-size: 40px;
    color: var(--primary);
  }
  
  .permission-modal-title {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 16px;
    color: var(--text-primary);
  }
  
  .permission-modal-text {
    font-size: 15px;
    line-height: 1.5;
    text-align: center;
    color: var(--text-secondary);
    margin-bottom: 32px;
    padding: 0 8px;
  }
  
  .permission-modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }
  
  .permission-modal-btn {
    flex: 1;
    padding: 16px;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
    border: none;
  }
  
  .permission-modal-btn.cancel {
    background: var(--surface);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }
  
  .permission-modal-btn.cancel:active {
    background: rgba(0, 0, 0, 0.05);
  }
  
  .permission-modal-btn.primary {
    background: var(--primary);
    color: white;
  }
  
  .permission-modal-btn.primary:active {
    background: var(--secondary);
    transform: scale(0.98);
  }

  /* --- ARAMA MODU --- */
  body.is-searching {
      overflow: hidden;
  }

  body.is-searching .tabs-container,
  body.is-searching .bottom-nav,
  body.is-searching .fab-container,
  body.is-searching .header-content {
      display: none !important;
  }

  body.is-searching .top-bar-container {
      max-height: var(--header-height);
      box-shadow: none;
      border-bottom: 1px solid var(--border);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
  }

  body.is-searching .main-content {
      padding-top: calc(var(--header-height) + var(--safe-top));
      padding-bottom: 0;
      height: 100vh;
      overflow-y: auto;
  }

  body.is-searching .grid {
      padding-top: 16px !important;
      padding-bottom: 20px;
  }

  body.is-searching .content-panel {
      height: 100%;
      position: static;
      opacity: 1;
      transform: none;
      pointer-events: all;
  }

  /* --- SELECTION MODE STYLES --- */
  body.selection-mode .bottom-nav,
  body.selection-mode .fab-container,
  body.selection-mode .header-content,
  body.selection-mode .tabs-container {
      display: none !important;
  }
  
  body.selection-mode .top-bar-container {
      background: var(--primary);
      color: white;
      height: var(--header-height);
      max-height: var(--header-height);
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
  }
  
  body.selection-mode .selection-header {
      display: flex !important;
      padding: 0 var(--spacing-sm); 
      align-items: center;
      justify-content: space-between;
      height: 100%;
      width: 100%;
      margin-top: var(--safe-top);
  }
  
  body.selection-mode .selection-count {
      font-size: 16px;
      font-weight: 500;
      margin-left: 8px;
      white-space: nowrap;
  }
  
  body.selection-mode .selection-actions {
      display: flex;
      align-items: center;
      gap: 2px; 
      overflow-x: auto; 
  }
  
  body.selection-mode .icon-button.selection {
      color: white;
      width: 36px;
      height: 36px;
      flex-shrink: 0;
  }
  
  body.selection-mode .icon-button.selection:hover {
      background: rgba(255, 255, 255, 0.1);
  }
  
  body.selection-mode .card {
      position: relative;
      cursor: default;
  }
  
  body.selection-mode .card:active {
      transform: none;
      background: var(--surface);
  }
  
  body.selection-mode .card.selected {
      background: var(--selection-bg);
      border-color: var(--selection-border);
      border-width: 2px;
  }
  
  .selection-checkbox {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-secondary);
      border-radius: 4px;
      background: var(--surface);
      z-index: 2;
      display: none;
  }
  
  body.selection-mode .selection-checkbox {
      display: block;
  }
  
  .selection-checkbox.selected {
      background: var(--primary);
      border-color: var(--primary);
  }
  
  .selection-checkbox.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
  }
  
  .selection-header {
      display: none;
  }

  /* --- ARAÃ‡LAR KARTLARI STÄ°LLERÄ° --- */
  .tools-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
  }
  
  .tool-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-md);
      min-height: 120px;
  }
  
  .tool-card:active {
      transform: scale(0.98);
      background: rgba(0,0,0,0.02);
  }
  
  .tool-icon-wrapper {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 28px;
  }
  
  .tool-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
  }

  /* --- 3. ÃœST BAR (STICKY HEADER) --- */
  .top-bar-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      max-height: var(--top-bar-total); 
      z-index: var(--z-top-bar);
      background: var(--surface);
      transition: transform 0.3s ease, max-height 0.3s ease, background-color 0.3s ease;
      box-shadow: var(--shadow-md);
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
  }
  .top-bar-container.tabs-hidden {
      max-height: var(--header-height);
  }
  .app-header { 
      height: var(--header-height); 
      padding: 0 var(--spacing-lg); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 1px solid var(--border);
      position: relative; 
      margin-top: var(--safe-top);
  }

  /* --- ARAMA Ã‡UBUÄžU STÄ°LLERÄ° --- */
  .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      transition: opacity 0.2s ease;
      margin-top: var(--safe-top);
  }
  .header-content.hidden {
      opacity: 0;
      pointer-events: none;
      display: none;
  }
  .search-bar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--surface);
      display: flex;
      align-items: center;
      padding: 0 var(--spacing-sm);
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      margin-top: var(--safe-top);
  }
  .search-bar-container.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
  }
  .search-input-wrapper {
      flex: 1;
      background: rgba(0, 0, 0, 0.05);
      border-radius: var(--radius-full);
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      margin: 0 8px;
  }
  [data-theme="dark"] .search-input-wrapper {
      background: rgba(255, 255, 255, 0.1);
  }
  .search-input {
      background: transparent;
      border: none;
      width: 100%;
      height: 100%;
      outline: none;
      font-family: 'Roboto', sans-serif;
      font-size: 15px;
      color: var(--text-primary);
      margin-left: 8px;
  }

  /* --- TABS --- */
  .tabs-container { 
      height: var(--tabs-height);
      padding: 0 var(--spacing-lg); 
      border-bottom: 1px solid var(--border);
      transition: opacity 0.3s ease;
      /* âœ… Left/right safe-area desteÄŸi */
      padding-left: calc(var(--spacing-lg) + var(--safe-left));
      padding-right: calc(var(--spacing-lg) + var(--safe-right));
  }
  .top-bar-container.tabs-hidden .tabs-container {
      opacity: 0;
      height: 0;
      border-bottom: none;
      padding: 0;
      pointer-events: none;
  }
  .tabs { display: flex; width: 100%; height: 100%; gap: var(--spacing-sm); }
  .tab { 
      flex: 1;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      text-align: center;
      color: var(--text-secondary); 
      font-weight: 500; 
      cursor: pointer; 
      position: relative;
      transition: color var(--transition-fast);
      gap: 2px;
  }
  .tab-label { font-size: 11px; line-height: 1.2; font-weight: 600; }
  .tab.active { color: var(--primary); }
  .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }
  
  .logo { 
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      overflow: hidden; 
      flex-shrink: 0;
  } 
  .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  .app-title { 
    font-size: 20px; 
    font-weight: 700; 
    background: linear-gradient(to right, #B71C1C, #FF6961); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text; 
  }
  .icon-button { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
  .icon-button:hover { background: rgba(0, 0, 0, 0.05); color: var(--text-primary); }
  .icon-button.primary { background: var(--primary); color: white; }

  /* --- 4. ANA Ä°Ã‡ERÄ°K ALANI --- */
  .main-content {
      padding-top: calc(var(--top-bar-total) + var(--safe-top));
      padding-bottom: calc(var(--bottom-nav-height) + var(--safe-bottom));
      height: 100vh;
      width: 100%;
      overflow: hidden; 
      position: relative;
      z-index: var(--z-content);
      transition: padding 0.3s ease;
      /* âœ… Left/right safe-area desteÄŸi */
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
  }
  .content-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%; 
      overflow-y: auto; 
      overscroll-behavior-y: contain; 
      opacity: 0;
      transform: translateX(20px);
      transition: opacity var(--transition-normal), transform var(--transition-normal);
      pointer-events: none;
      box-sizing: border-box; 
  }
  .static-panel {
      padding-top: calc(var(--header-height) + var(--safe-top) + 16px);
      overflow-y: auto; 
  }
  .content-panel.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: all;
  }
  
  .grid { 
      display: grid; 
      gap: 10px; 
      grid-template-columns: 1fr;
      padding: calc(var(--top-bar-total) + var(--safe-top) + 16px) var(--card-gutter) 120px var(--card-gutter); 
      width: 100%;
      /* âœ… Left/right safe-area desteÄŸi */
      padding-left: calc(var(--card-gutter) + var(--safe-left));
      padding-right: calc(var(--card-gutter) + var(--safe-right));
  }
  
  .static-panel .grid {
      padding-top: 0 !important;
      padding-bottom: 120px;
  }

  /* --- 5. PDF KART TASARIMI --- */
  .card { 
    background: var(--surface); 
    border-radius: var(--radius-md); 
    border: 1px solid var(--border); 
    padding: var(--card-padding); 
    transition: all var(--transition-normal); 
    cursor: pointer; 
    box-shadow: var(--shadow-md); 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    width: 100%; 
    max-width: var(--card-max-width);
    margin: 0 auto;
    user-select: none; 
    -webkit-user-select: none;
    position: relative;
  }
  .card:active { transform: scale(0.98); background: rgba(0,0,0,0.02); }
  .card.hidden { display: none !important; } 
  
  .card-icon-svg-wrapper {
      width: var(--card-icon-size); 
      height: var(--card-icon-size); 
      flex-shrink: 0;
      margin-left: 4px;
  }
  
  .card-details {
      flex-grow: 1;
      flex-basis: 50%; 
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  
  .card-title { 
    font-size: 14px; 
    font-weight: 600; 
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .card-meta {
      display: flex;
      align-items: center;
      gap: 6px; 
      font-size: 11px; 
      color: var(--text-secondary);
      margin-top: 2px;
      flex-wrap: wrap;
  }

  .card-actions {
      display: flex;
      align-items: center;
      flex-shrink: 0;
  }

  /* --- 6. DÄ°ÄžER STÄ°LLER --- */
  .menu-list {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-radius: var(--radius-lg);
      width: calc(100% - 2 * var(--card-gutter));
      max-width: calc(var(--card-max-width) + 24px);
      margin: 0 auto;
      /* âœ… Left/right safe-area desteÄŸi */
      margin-left: calc(var(--card-gutter) + var(--safe-left));
      margin-right: calc(var(--card-gutter) + var(--safe-right));
  }
  .menu-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px var(--spacing-md); 
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.1s;
  }
  .menu-item:last-child {
      border-bottom: none;
  }
  .menu-item:active {
      background-color: rgba(0, 0, 0, 0.05);
  }
  .menu-item-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
  }
  .menu-icon-wrapper {
      width: 28px; 
      height: 28px; 
      display: flex;
      align-items: center;
      justify-content: center;
  }
  .menu-icon-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
  }
  .menu-label-wrapper {
      display: flex;
      flex-direction: column;
  }
  .menu-label {
      font-size: 15px; 
      font-weight: 500;
      line-height: 1.2;
  }
  .menu-sublabel {
      font-size: 11px; 
      color: var(--text-secondary);
      line-height: 1.2;
  }
  .icon-device { color: var(--text-primary); }
  .icon-shared { color: var(--primary); }
  .icon-photos { color: #f94144; } 
  .icon-yandex { color: #FF0000; } 
  .icon-mega { background-color: #D60914; color: white; border-radius: 4px; font-size: 16px !important; padding: 4px; } 
  .icon-gdrive { color: #34A853; }
  .icon-onedrive { color: #0078D4; }
  .icon-dropbox { color: #0061FF; }
  .icon-gmail { background-color: #EA4335; color: white; border-radius: 4px; font-size: 16px !important; padding: 4px; }
  .icon-folder-open { color: var(--text-secondary); }
  .bottom-nav { 
      height: calc(var(--bottom-nav-height) + var(--safe-bottom)); 
      background: var(--surface); 
      border-top: 1px solid var(--border); 
      display: flex; 
      align-items: center; 
      justify-content: space-around; 
      position: fixed; 
      bottom: 0; 
      width: 100%;
      z-index: var(--z-bottom-nav); 
      /* âœ… Bottom safe-area desteÄŸi */
      padding-bottom: var(--safe-bottom);
      /* âœ… Left/right safe-area desteÄŸi */
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
  }
  .nav-item { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 4px; 
      padding: 8px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      transition: color var(--transition-fast); 
  }
  .nav-item.active { color: var(--primary); }
  .nav-label { font-size: 11px; font-weight: 500; }
  .fab-container { 
      position: fixed; 
      bottom: calc(90px + var(--safe-bottom)); 
      right: calc(24px + var(--safe-right)); 
      z-index: var(--z-bottom-nav); 
  }
  .fab { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; }
  .fab-menu { position: absolute; bottom: 70px; right: 0; background: var(--surface); border-radius: 12px; padding: 8px; width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(10px); pointer-events: none; transition: all 0.2s; border: 1px solid var(--border); }
  .fab-menu.show { opacity: 1; transform: translateY(0); pointer-events: all; }
  .fab-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; }
  .fab-item:active { background: rgba(0, 0, 0, 0.05); }

  /* --- DRAWER (SOL MENÃœ) --- */
  .drawer-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: var(--z-overlay); 
      opacity: 0; 
      visibility: hidden; 
      transition: 0.3s; 
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
  }
  .drawer-overlay.show { opacity: 1; visibility: visible; }
  .drawer { 
      position: fixed; 
      top: 0; 
      left: 0; 
      bottom: 0; 
      width: 280px; 
      background: var(--surface); 
      z-index: var(--z-overlay); 
      transform: translateX(-100%); 
      transition: 0.3s; 
      display: flex; 
      flex-direction: column; 
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
  }
  .drawer.open { transform: translateX(0); }
  .drawer-header { 
    padding: calc(32px + var(--safe-top)) 24px 16px 24px; 
    background: var(--surface); 
    color: var(--text-primary); 
    border-bottom: 2px solid var(--primary); 
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-shrink: 0;
  }
  .drawer-header h3 {
      font-size: 24px;
      font-weight: 700; 
      background: linear-gradient(to right, #B71C1C, #FF6961); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
      display: inline;
  }
  .drawer-logo {
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      overflow: hidden; 
      flex-shrink: 0;
  }
  .drawer-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  .drawer-content { 
    padding: 16px; 
    overflow-y: auto; 
  }
  .drawer-item { 
    padding: 12px; 
    display: flex; 
    gap: 16px; 
    align-items: center; 
    border-radius: 8px; 
    margin-bottom: 4px; 
    cursor: pointer; 
    transition: background-color 0.1s;
  }
  .drawer-item:hover { background: rgba(0, 0, 0, 0.05); }
  .drawer-item:active { background: rgba(0, 0, 0, 0.1); } 

  .drawer-accordion-content {
    background: rgba(0, 0, 0, 0.03); 
    border-radius: 8px;
    margin-top: -4px;
    margin-bottom: 8px;
    padding: 0 16px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  .drawer-accordion-content.open {
    max-height: 500px;
    padding: 12px 16px;
    border: 1px solid var(--border);
  }

  /* --- CONTEXT MENU (ALT Ã‡EKMECE) --- */
  .context-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-context-menu);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
      /* âœ… Safe-area desteÄŸi */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
  }
  .context-sheet-overlay.show {
      opacity: 1;
      visibility: visible;
  }
  .context-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      z-index: var(--z-context-menu);
      border-radius: 20px 20px 0 0;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 24px 0;
      border-top: 1px solid var(--border);
      /* âœ… Bottom safe-area desteÄŸi */
      padding-bottom: var(--safe-bottom);
  }
  .context-sheet.show {
      transform: translateY(0);
  }
  .sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--text-secondary);
      border-radius: 2px;
      margin: -10px auto 20px auto;
      opacity: 0.3;
  }
  .sheet-header {
      padding: 0 24px 16px 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
  }
  .sheet-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }
  .sheet-meta {
      font-size: 12px;
      color: var(--text-secondary);
  }
  .sheet-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-primary);
  }
  .sheet-item:active {
      background: rgba(0,0,0,0.05);
  }
  .sheet-item.danger {
      color: var(--error);
  }
  .sheet-item .material-symbols-rounded {
      font-size: 24px;
      color: inherit;
  }
  
  /* --- SETTINGS STYLES --- */
  .settings-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
  }
  .setting-tab {
      flex: 1;
      padding: 8px 4px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all var(--transition-fast);
  }
  .setting-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
  }
  .setting-panel {
      padding: 8px 0;
      display: none;
      animation: fadeIn 0.3s;
  }
  .setting-panel.active {
      display: block;
  }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
  }
  .select-placeholder {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 8px;
      color: var(--text-primary);
      background: var(--surface);
      display: block;
      width: 100%;
      text-align: left;
  }
  .theme-options {
      display: flex;
      gap: 16px;
      margin-top: 12px;
  }
  .theme-option {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all var(--transition-fast);
  }
  .theme-option.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.3);
      background: rgba(var(--primary-rgb), 0.05);
  }
  .theme-option .material-symbols-rounded {
      font-size: 32px;
      margin-bottom: 4px;
      color: var(--text-secondary);
  }
  .theme-option.active .material-symbols-rounded {
      color: var(--primary);
  }
  .theme-option p {
      font-size: 12px;
      font-weight: 500;
  }
  .help-form input, .help-form textarea, .help-form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-sizing: border-box;
      background: var(--surface);
      color: var(--text-primary);
  }
  .help-form textarea {
      resize: vertical;
      min-height: 100px;
  }
  .help-form button {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition-fast);
  }
  .help-form button:hover {
      background-color: var(--secondary);
  }
  .empty-state { padding: 40px; text-align: center; color: var(--text-secondary); }
  .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
  
  /* --- Ä°ZÄ°N BANNER STÄ°LLERÄ° --- */
  .permission-banner {
      padding: 20px;
      text-align: center;
      background: var(--surface);
      border-radius: 12px;
      margin: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      /* âœ… Left/right safe-area desteÄŸi */
      margin-left: calc(20px + var(--safe-left));
      margin-right: calc(20px + var(--safe-right));
  }
  .permission-banner img {
      margin-top:100px;
      width: 120px;
      opacity: 0.7;
      margin-bottom: 16px;
  }
  .permission-banner h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text-primary);
  }
  .permission-banner p {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
  }
  .permission-banner button {
      padding: 12px 20px;
      border-radius: 12px;
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition-fast);
  }
  .permission-banner button:hover {
      background: var(--secondary);
  }
</style>
</head>
<body>

  <input type="file" id="pdfFileInput" accept="application/pdf" style="display: none;" onchange="handleFileSelect(event)" multiple>

  <!-- PERMISSION MODAL -->
  <div class="permission-modal-overlay" id="permissionModalOverlay">
    <div class="permission-modal">
      <div class="permission-modal-icon">
        <span class="material-symbols-rounded">folder_open</span>
      </div>
      <h2 class="permission-modal-title">Dosya EriÅŸimi Gerekli</h2>
      <p class="permission-modal-text">
        CihazÄ±nÄ±zdaki dosyalarÄ± gÃ¶rmek, dÃ¼zenlemek ve gÃ¼ncellemek iÃ§in lÃ¼tfen gerekli izni verin.
      </p>
      <div class="permission-modal-buttons">
        <button class="permission-modal-btn cancel" onclick="closePermissionModal()">Åžimdi DeÄŸil</button>
        <button class="permission-modal-btn primary" onclick="openSettingsForPermission()">Ayarlara Gidin</button>
      </div>
    </div>
  </div>

  <div class="top-bar-container" id="topBar">
    <header class="app-header">
      
      <div class="header-content" id="headerNormal">
        <div class="flex items-center gap-sm">
          <div class="logo">
              <img src="img/logo.png" alt="PDF Reader Logo">
          </div>
          <h1 class="app-title">PDF Reader</h1>
        </div>
        <div class="flex items-center gap-sm">
          <button class="icon-button" id="searchBtn"><span class="material-symbols-rounded">search</span></button>
          <button class="icon-button" id="menuBtn"><span class="material-symbols-rounded">menu</span></button>
        </div>
      </div>

      <div class="search-bar-container" id="searchBar">
          <button class="icon-button" id="closeSearchBtn">
              <span class="material-symbols-rounded">arrow_back</span>
          </button>
          <div class="search-input-wrapper">
              <span class="material-symbols-rounded text-secondary" style="font-size: 20px;">search</span>
              <input type="text" class="search-input" id="searchInput" placeholder="PDF Ara...">
          </div>
          <button class="icon-button" onclick="document.getElementById('searchInput').value = ''; triggerSearch();">
              <span class="material-symbols-rounded">close</span>
          </button>
      </div>
      
      <div class="selection-header" id="selectionHeader">
          <div class="selection-count" id="selectionCount">0 Ã¶ÄŸe seÃ§ildi</div>
          <div class="selection-actions">
              <button class="icon-button selection" title="TÃ¼mÃ¼nÃ¼ SeÃ§" onclick="selectAllCards()">
                  <span class="material-symbols-rounded">select_all</span>
              </button>
              <button class="icon-button selection" title="SeÃ§imi KaldÄ±r" onclick="deselectAllCards()">
                  <span class="material-symbols-rounded">deselect</span>
              </button>
              <button class="icon-button selection" title="PaylaÅŸ" onclick="shareSelectedCards()">
                  <span class="material-symbols-rounded">share</span>
              </button>
              <button class="icon-button selection" title="YazdÄ±r" onclick="printSelectedCards()">
                  <span class="material-symbols-rounded">print</span>
              </button>
              <button class="icon-button selection" title="Sil" onclick="deleteSelectedCards()">
                  <span class="material-symbols-rounded">delete</span>
              </button>
              <button class="icon-button selection" title="Kapat" onclick="exitSelectionMode()">
                  <span class="material-symbols-rounded">close</span>
              </button>
          </div>
      </div>

    </header>

    <div class="tabs-container" id="tabsContainer">
      <div class="tabs">
        <div class="tab active" data-tab="recent">
          <span class="material-symbols-rounded">history</span> 
          <span class="tab-label">Son KullanÄ±lanlar</span>
        </div>
        
        <div class="tab" data-tab="favorites">
          <span class="material-symbols-rounded">star</span> 
          <span class="tab-label">Favoriler</span>
        </div>
        
        <div class="tab" data-tab="device">
          <span class="material-symbols-rounded">phone_iphone</span> 
          <span class="tab-label">Cihazda</span>
        </div>
      </div>
    </div>
  </div>

  <main class="main-content" id="mainContent">
    
    <div class="content-panel active" id="recentPanel">
      <div class="grid" id="recentList"></div>
    </div>

    <div class="content-panel" id="favoritesPanel">
      <div class="grid" id="favoritesList"></div>
    </div>

    <div class="content-panel" id="devicePanel">
      <!-- Ä°ZÄ°N BANNERÄ° -->
      <div class="permission-banner" id="permissionContainer">
        <img src="img/permission.png" alt="Ä°zin Gerekiyor">
        <h3>CihazÄ±nÄ±zdaki PDF'lere eriÅŸebilmem iÃ§in izin gerekli</h3>
        <p>Devam etmek iÃ§in TÃ¼m Dosya EriÅŸimi izni verin.</p>
        <button onclick="requestStoragePermission()">
            Ayarlardan EriÅŸim Ver
        </button>
      </div>
      
      <!-- PDF LÄ°STESÄ° -->
      <div class="grid" id="deviceList"></div>
    </div>
    
    <div class="content-panel static-panel" id="filesPanel">
      <div class="grid">
        <div class="menu-list">
        
          <div class="menu-item" onclick="handleFileSource('device')">
            <div class="menu-item-info">
              <div class="menu-icon-wrapper">
                <img src="img/smartphone.svg" alt="Bu aygÄ±tta">
              </div>
              <span class="menu-label">Bu aygÄ±tta</span>
            </div>
            <span class="material-symbols-rounded text-secondary">chevron_right</span>
          </div>

          <div class="menu-item" onclick="handleFileSource('gdrive')">
            <div class="menu-item-info">
              <div class="menu-icon-wrapper">
                <img src="img/googledrive.svg" alt="Google Drive">
              </div>
              <span class="menu-label">Google Drive</span>
            </div>
            <span class="material-symbols-rounded text-secondary">add</span>
          </div>

          <div class="menu-item" onclick="handleFileSource('onedrive')">
            <div class="menu-item-info">
              <div class="menu-icon-wrapper">
                <img src="img/onedrive.svg" alt="OneDrive">
              </div>
              <span class="menu-label">OneDrive</span>
            </div>
            <span class="material-symbols-rounded text-secondary">add</span>
          </div>

          <div class="menu-item" onclick="handleFileSource('dropbox')">
            <div class="menu-item-info">
              <div class="menu-icon-wrapper">
                <img src="img/dropbox.svg" alt="Dropbox">
              </div>
              <span class="menu-label">Dropbox</span>
            </div>
            <span class="material-symbols-rounded text-secondary">add</span>
          </div>

          <div class="menu-item" onclick="handleFileSource('gmail')">
            <div class="menu-item-info">
              <div class="menu-icon-wrapper">
                <img src="img/gmail.svg" alt="E-postalardaki PDF'ler">
              </div>
              <div class="menu-label-wrapper">
                <span class="menu-label">E-postalardaki PDF'ler</span>
                <span class="menu-sublabel">Gmail</span>
              </div>
            </div>
            <span class="material-symbols-rounded text-secondary">add</span>
          </div>

          <div class="menu-item" onclick="handleFileSource('browse_more')">
            <div class="menu-item-info">
              <span class="material-symbols-rounded menu-icon-wrapper icon-folder_open">folder_open</span>
              <span class="menu-label">Daha fazla dosyaya gÃ¶z atÄ±n</span>
            </div>
            <span class="material-symbols-rounded text-secondary">chevron_right</span>
          </div>

        </div>
      </div>
    </div>
    
    <div class="content-panel static-panel" id="toolsPanel">
        <div class="tools-grid" id="toolsGrid">
            <!-- AraÃ§lar kartlarÄ± JavaScript ile eklenecek -->
        </div>
    </div>

  </main>

  <div class="fab-container">
    <div class="fab-menu" id="fabMenu">
      <div class="fab-item" onclick="handleFabAction('open_pdf')">
        <span class="material-symbols-rounded">folder_open</span> PDF AÃ§
      </div>
    </div>
    <button class="fab" id="fabButton"><span class="material-symbols-rounded">add</span></button>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-nav="home">
      <span class="material-symbols-rounded">home</span>
      <span class="nav-label">Ana Sayfa</span>
    </div>
    <div class="nav-item" data-nav="tools">
      <span class="material-symbols-rounded">tune</span>
      <span class="nav-label">AraÃ§lar</span>
    </div>
    <div class="nav-item" data-nav="files">
      <span class="material-symbols-rounded">folder</span>
      <span class="nav-label">Dosyalar</span>
    </div>
  </nav>

  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-logo">
          <img src="img/logo.png" alt="PDF Reader Logo">
      </div>
      <h3>PDF Reader</h3>
      </div>
    <div class="drawer-content">
      
      <div class="drawer-item" data-accordion="about">
        <span class="material-symbols-rounded">info</span> HakkÄ±nda
      </div>
      <div class="drawer-accordion-content" id="accordion-about">
        <p><strong>PDF Reader by Dev Software</strong></p>
        <p>Bu uygulama, PDF dosyalarÄ±nÄ± hÄ±zlÄ±, gÃ¼venli ve verimli bir ÅŸekilde gÃ¶rÃ¼ntÃ¼lemek, yÃ¶netmek ve temel dÃ¼zeyde dÃ¼zenlemek iÃ§in tasarlanmÄ±ÅŸtÄ±r.</p>
        <p>AmacÄ±mÄ±z, en iyi mobil PDF deneyimini sunmaktÄ±r. Devam eden gÃ¼ncellemeler ve iyileÅŸtirmeler iÃ§in bizi takipte kalÄ±n!</p>
        <p class="text-sm mt-3">TÃ¼m HaklarÄ± SaklÄ±dÄ±r &copy; 2025 Dev Software.</p>
      </div>

      <div class="drawer-item" data-accordion="settings">
        <span class="material-symbols-rounded">settings</span> Ayarlar & Tercihler
      </div>
      <div class="drawer-accordion-content" id="accordion-settings">
        <div class="settings-tabs">
            <div class="setting-tab active" data-tab="app-lang">Uygulama Dili</div>
            <div class="setting-tab" data-tab="pdf-lang">PDF Dili</div>
        </div>
        
        <div class="setting-panel active" data-panel="app-lang">
            <p class="text-sm font-semibold">Uygulama arayÃ¼zÃ¼nÃ¼n dilini seÃ§in.</p>
            <select class="select-placeholder" onchange="alert('Uygulama dili ayarlanÄ±yor: ' + this.value)">
                <option value="" disabled selected>Uygulama Dili SeÃ§iniz</option>
                <option value="tr">TÃ¼rkÃ§e (Turkish)</option>
                <option value="en">Ä°ngilizce (English)</option>
                </select>
        </div>

        <div class="setting-panel" data-panel="pdf-lang">
            <p class="text-sm font-semibold">PDF'leri gÃ¶rÃ¼ntÃ¼leme ve metin kopyalama/arama iÃ§in OCR dilini seÃ§in.</p>
            <select class="select-placeholder" onchange="alert('PDF GÃ¶rÃ¼ntÃ¼leyici dili ayarlanÄ±yor: ' + this.value)">
                <option value="" disabled selected>GÃ¶rÃ¼ntÃ¼leyici Dili SeÃ§iniz (50+ Dil)</option>
                <option value="tr">TÃ¼rkÃ§e</option>
                <option value="en">Ä°ngilizce</option>
            </select>
        </div>

        <div class="setting-panel" data-panel="theme">
            <p class="text-sm font-semibold mb-2">UygulamanÄ±n gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ seÃ§in.</p>
            <div class="theme-options">
                <div class="theme-option active" data-theme-val="device" onclick="setThemePreference('device')">
                    <span class="material-symbols-rounded">phone_android</span>
                    <p>Cihaz</p>
                </div>
                <div class="theme-option" data-theme-val="light" onclick="setThemePreference('light')">
                    <span class="material-symbols-rounded">light_mode</span>
                    <p>Light</p>
                </div>
                <div class="theme-option" data-theme-val="dark" onclick="setThemePreference('dark')">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <p>Dark</p>
                </div>
            </div>
            <p class="text-sm text-secondary mt-3">VarsayÄ±lan olarak cihaz ayarlarÄ± kullanÄ±lÄ±r. SeÃ§iminiz tarayÄ±cÄ±nÄ±zda saklanacaktÄ±r.</p>
        </div>
      </div>

      <div class="drawer-item" data-accordion="privacy">
        <span class="material-symbols-rounded">lock</span> Gizlilik
      </div>
      <div class="drawer-accordion-content" id="accordion-privacy">
        <p>KiÅŸisel verilerinizin ve belge gizliliÄŸinizin bizim iÃ§in en Ã¶nemli Ã¶ncelik olduÄŸunu garanti ederiz. Uygulama, dosyalarÄ±nÄ±zÄ± sunucularÄ±mÄ±za yÃ¼klemeden cihazÄ±nÄ±zda yerel olarak iÅŸleyecek ÅŸekilde tasarlanmÄ±ÅŸtÄ±r.</p>
        <p><strong>Dev Software</strong> olarak, kullanÄ±cÄ±larÄ±mÄ±zÄ±n hiÃ§bir kiÅŸisel verisini Ã¼Ã§Ã¼ncÃ¼ taraflarla paylaÅŸmayÄ±z.</p>
        <p class="mt-3 font-semibold">Daha fazla bilgi iÃ§in:</p>
        <a href="#" onclick="alert('Gizlilik PolitikasÄ± sayfasÄ±na yÃ¶nlendiriliyor...')" class="text-sm text-primary">Gizlilik PolitikasÄ± iÃ§in TÄ±klayÄ±nÄ±z</a>
      </div>

      <div class="drawer-item" data-accordion="help">
        <span class="material-symbols-rounded">help</span> YardÄ±m
      </div>
      <div class="drawer-accordion-content" id="accordion-help">
        <form class="help-form" onsubmit="sendHelpEmail(event)">
            <p class="text-sm mb-2">Sorununuzu bize iletin. Ekibimiz en kÄ±sa sÃ¼rede dÃ¶nÃ¼ÅŸ yapacaktÄ±r.</p>
            <input type="email" id="helpEmail" placeholder="E-posta Adresiniz" required>
            <input type="text" id="helpSubject" placeholder="Konu BaÅŸlÄ±ÄŸÄ±" required>
            <textarea id="helpIssue" placeholder="Sorununuzu detaylÄ±ca aÃ§Ä±klayÄ±nÄ±z..." required></textarea>
            <button type="submit">GÃ¶nder</button>
            <p class="text-sm text-secondary text-center mt-2">Bu e-posta devsoftawaremail@gmail.com adresine yÃ¶nlendirilecektir.</p>
        </form>
      </div>

    </div>
  </aside>

  <div class="context-sheet-overlay" id="contextOverlay"></div>
  <div class="context-sheet" id="contextSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
        <h3 class="sheet-title" id="contextTitle">Belge AdÄ±.pdf</h3>
        <span class="sheet-meta" id="contextMeta">2.5 MB â€¢ 12.05.2025</span>
    </div>
    <div class="sheet-item" onclick="handleContextAction('rename')">
        <span class="material-symbols-rounded">edit</span> Yeniden AdlandÄ±r
    </div>
    <div class="sheet-item" onclick="handleContextAction('share')">
        <span class="material-symbols-rounded">share</span> PaylaÅŸ
    </div>
    <div class="sheet-item" onclick="handleContextAction('print')">
        <span class="material-symbols-rounded">print</span> YazdÄ±r
    </div>
    <div class="sheet-item danger" onclick="handleContextAction('delete')">
        <span class="material-symbols-rounded">delete</span> Sil
    </div>
  </div>



<!-- Script kismi -->



<script>


// =============================================================================
// 1. INDEXEDDB PDF MANAGER - ANDROID WEBVIEW UYUMLU
// =============================================================================

class IndexedDBPdfManager {
    constructor() {
        this.db = null;
        this.dbName = 'PDFReaderDB';
        this.storeName = 'pdfs';
        this.isInitialized = false;
    }

    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 2); // Version 2'ye gÃ¼ncellendi
            
            request.onerror = () => {
                console.error("âŒ IndexedDB aÃ§Ä±lamadÄ±");
                reject(false);
            };
            
            request.onsuccess = (event) => {
                this.db = event.target.result;
                this.isInitialized = true;
                console.log("âœ… IndexedDB baÅŸlatÄ±ldÄ±");
                resolve(true);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                
                if (oldVersion < 1) {
                    // Ä°lk versiyon
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
                
                if (oldVersion < 2) {
                    // Path alanÄ±nÄ± eklemek iÃ§in store'u recreate et
                    const store = event.currentTarget.transaction.objectStore(this.storeName);
                    const allRequest = store.getAll();
                    
                    allRequest.onsuccess = () => {
                        const allData = allRequest.result;
                        db.deleteObjectStore(this.storeName);
                        const newStore = db.createObjectStore(this.storeName, { keyPath: 'id' });
                        
                        // Eski verileri geri yÃ¼kle
                        allData.forEach(item => {
                            newStore.put(item);
                        });
                    };
                }
            };
        });
    }

    async savePdfToIndexedDB(file, fileName = null, filePath = null) {
        try {
            if (!this.isInitialized) {
                await this.init();
            }

            const pdfName = fileName || file.name || `document_${Date.now()}.pdf`;
            const arrayBuffer = await file.arrayBuffer();
            const sizeInMB = file.size / (1024 * 1024);
            
            console.log(`ðŸ“„ PDF IndexedDB'ye kaydediliyor: ${pdfName} (${sizeInMB.toFixed(2)} MB)`);
            
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                
                const fileData = {
                    id: pdfName,
                    name: pdfName,
                    data: arrayBuffer,
                    size: file.size,
                    timestamp: Date.now(),
                    filePath: filePath || null
                };
                
                const request = store.put(fileData);
                
                request.onsuccess = () => {
                    const currentData = {
                        id: 'current',
                        name: pdfName,
                        data: arrayBuffer,
                        size: file.size,
                        timestamp: Date.now(),
                        filePath: filePath || null
                    };
                    
                    const currentRequest = store.put(currentData);
                    
                    currentRequest.onsuccess = () => {
                        sessionStorage.setItem('currentPdfName', pdfName);
                        sessionStorage.setItem('usingIndexedDB', 'true');
                        
                        console.log(`âœ… PDF IndexedDB'ye kaydedildi: ${pdfName}`);
                        resolve({ success: true, name: pdfName, size: file.size, method: 'indexeddb' });
                    };
                    
                    currentRequest.onerror = () => {
                        console.warn("âš ï¸ current.pdf kaydedilemedi");
                        resolve({ success: true, name: pdfName, size: file.size, method: 'indexeddb' });
                    };
                };
                
                request.onerror = () => {
                    reject(new Error("IndexedDB kayÄ±t hatasÄ±"));
                };
            });
            
        } catch (error) {
            console.error("âŒ PDF kaydetme hatasÄ±:", error);
            return { success: false, error: error.message };
        }
    }

    async getCurrentPdfUrl() {
        try {
            if (!this.isInitialized) {
                await this.init();
            }

            const pdfName = sessionStorage.getItem('currentPdfName') || 'current';
            
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(pdfName);
                
                request.onsuccess = (e) => {
                    const result = e.target.result;
                    
                    if (!result) {
                        const currentRequest = store.get('current');
                        currentRequest.onsuccess = (e2) => {
                            const currentResult = e2.target.result;
                            if (currentResult && currentResult.data) {
                                const blob = new Blob([currentResult.data], { type: 'application/pdf' });
                                const url = URL.createObjectURL(blob);
                                sessionStorage.setItem('currentPdfBlobUrl', url);
                                console.log("âœ… PDF Blob URL oluÅŸturuldu");
                                resolve(url);
                            } else {
                                resolve(null);
                            }
                        };
                        currentRequest.onerror = () => resolve(null);
                    } else if (result && result.data) {
                        const blob = new Blob([result.data], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        sessionStorage.setItem('currentPdfBlobUrl', url);
                        console.log("âœ… PDF Blob URL oluÅŸturuldu");
                        resolve(url);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => {
                    reject(new Error("IndexedDB okuma hatasÄ±"));
                };
            });
            
        } catch (error) {
            console.error("âŒ PDF URL alma hatasÄ±:", error);
            return null;
        }
    }

    async getPdfFromIndexedDB(fileName) {
        try {
            if (!this.isInitialized) {
                await this.init();
            }

            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(fileName);
                
                request.onsuccess = (e) => {
                    const result = e.target.result;
                    if (result && result.data) {
                        const blob = new Blob([result.data], { type: 'application/pdf' });
                        console.log(`âœ… PDF IndexedDB'den okundu: ${fileName}`);
                        resolve(blob);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => {
                    reject(new Error("IndexedDB okuma hatasÄ±"));
                };
            });
            
        } catch (error) {
            console.error("âŒ PDF okuma hatasÄ±:", error);
            return null;
        }
    }

    async checkIfPdfExists(filePath) {
        try {
            if (!this.isInitialized) {
                await this.init();
            }

            return new Promise((resolve) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.openCursor();
                let exists = false;
                
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.filePath === filePath && cursor.value.id !== 'current') {
                            exists = true;
                        }
                        cursor.continue();
                    } else {
                        resolve(exists);
                    }
                };
                
                request.onerror = () => resolve(false);
            });
            
        } catch (error) {
            console.error("âŒ PDF kontrol hatasÄ±:", error);
            return false;
        }
    }

    cleanup() {
        const blobUrl = sessionStorage.getItem('currentPdfBlobUrl');
        if (blobUrl) {
            try {
                URL.revokeObjectURL(blobUrl);
                console.log("ðŸ—‘ï¸ Blob URL temizlendi");
            } catch (e) {
                console.warn("âš ï¸ Blob URL temizlenemedi");
            }
            sessionStorage.removeItem('currentPdfBlobUrl');
        }
        sessionStorage.removeItem('currentPdfName');
        sessionStorage.removeItem('usingIndexedDB');
    }

    async getAllPdfFiles() {
        try {
            if (!this.isInitialized) {
                await this.init();
            }
            
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.openCursor();
                const files = [];
                
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.id !== 'current') {
                            files.push({
                                name: cursor.value.name,
                                size: cursor.value.size,
                                timestamp: cursor.value.timestamp,
                                filePath: cursor.value.filePath || null
                            });
                        }
                        cursor.continue();
                    } else {
                        resolve(files);
                    }
                };
                
                request.onerror = () => {
                    reject(new Error("IndexedDB listeleme hatasÄ±"));
                };
            });
            
        } catch (error) {
            console.error("âŒ PDF listesi alma hatasÄ±:", error);
            return [];
        }
    }

    async getStorageInfo() {
        try {
            const estimate = await navigator.storage.estimate();
            const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
            const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
            const usagePercent = ((estimate.usage / estimate.quota) * 100).toFixed(1);
            
            console.log(`ðŸ“Š Storage KullanÄ±m: ${usedMB} MB / ${quotaMB} MB (${usagePercent}%)`);
            
            return {
                used: estimate.usage,
                quota: estimate.quota,
                usedMB: usedMB,
                quotaMB: quotaMB,
                usagePercent: usagePercent
            };
        } catch (e) {
            console.error("âŒ Storage bilgisi alÄ±namadÄ±:", e);
            return null;
        }
    }
}

const pdfManager = new IndexedDBPdfManager();

window.addEventListener('beforeunload', () => {
    pdfManager.cleanup();
});

console.log("âœ… IndexedDB PDF Manager yÃ¼klendi");

// =============================================================================
// 2. THEME INITIALIZATION
// =============================================================================

function initTheme() {
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const themeToSet = systemPrefersDark ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', themeToSet);
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    const newTheme = e.matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    if (typeof loadData === "function") loadData(); 
});

initTheme();

// =============================================================================
// 3. VARIABLES
// =============================================================================

const topBar = document.getElementById('topBar');
const mainContent = document.getElementById('mainContent');
const tabs = document.querySelectorAll('.tab');
const panels = document.querySelectorAll('.content-panel');
const navItems = document.querySelectorAll('.nav-item');
const fabButton = document.getElementById('fabButton');
const fabMenu = document.getElementById('fabMenu');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('drawerOverlay');
const drawerItems = document.querySelectorAll('.drawer-item[data-accordion]');
const settingsTabs = document.querySelectorAll('.setting-tab');
const pdfFileInput = document.getElementById('pdfFileInput');

const searchBtn = document.getElementById('searchBtn');
const headerNormal = document.getElementById('headerNormal');
const searchBar = document.getElementById('searchBar');
const searchInput = document.getElementById('searchInput');
const closeSearchBtn = document.getElementById('closeSearchBtn');

const contextOverlay = document.getElementById('contextOverlay');
const contextSheet = document.getElementById('contextSheet');
const contextTitle = document.getElementById('contextTitle');
const contextMeta = document.getElementById('contextMeta');
let currentContextFile = null;

const permissionModalOverlay = document.getElementById('permissionModalOverlay');

const selectionHeader = document.getElementById('selectionHeader');
const selectionCount = document.getElementById('selectionCount');
let isSelectionMode = false;
let selectedCards = new Set();

let importedFiles = [];
let devicePDFs = [];
let recentFiles = [];
let favoriteFiles = [];

let lastScrollY = 0;
let startX = 0;
let startY = 0;
let isSwiping = false; 
let isVerticalScroll = false; 
const headerHeight = 64; 
let currentNav = 'home';
const tabOrder = ['recent', 'favorites', 'device'];

const toolsData = [
  {
    id: 1,
    title: "PDF BirleÅŸtirme",
    icon: "merge",
    iconCode: "merge",
    color: "#E53935",
    page: "birlestirme.html"
  },
  {
    id: 2,
    title: "Sesli Okuma",
    icon: "volume_up",
    iconCode: "volume_up",
    color: "#4CAF50",
    page: "sesli_okuma.html"
  },
  {
    id: 3,
    title: "OCR Metin Ã‡Ä±karma",
    icon: "text_fields",
    iconCode: "text_fields",
    color: "#2196F3",
    page: "orc.html"
  },
  {
    id: 4,
    title: "PDF Ä°mzalama",
    icon: "draw",
    iconCode: "draw",
    color: "#9C27B0",
    page: "imza.html"
  },
  {
    id: 5,
    title: "PDF SÄ±kÄ±ÅŸtÄ±rma",
    icon: "compress",
    iconCode: "compress",
    color: "#FF9800",
    page: "sikistirma.html"
  },
  {
    id: 6,
    title: "PDF SayfalarÄ±nÄ± Organize Etme",
    icon: "reorder",
    iconCode: "reorder",
    color: "#795548",
    page: "organize.html"
  },
  {
    id: 7,
    title: "Resimden PDF",
    icon: "image",
    iconCode: "image",
    color: "#00BCD4",
    page: "resimden_pdf.html"
  },
  {
    id: 8,
    title: "PDF'den Resim",
    icon: "picture_as_pdf",
    iconCode: "picture_as_pdf",
    color: "#607D8B",
    page: "pdf_resme.html"
  }
];

// =============================================================================
// 4. INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', async () => {
  await pdfManager.init();
  
  loadRecentFromStorage();
  loadFavoritesFromStorage();
  loadData();
  loadTools();
  attachEvents();
  document.getElementById('recentPanel').scrollTop = 0;
  document.querySelector('.setting-tab').classList.add('active');
  document.querySelector('.setting-panel').classList.add('active');
  
  setTimeout(() => {
    if (currentNav === 'home') {
      scanDeviceForPDFs();
    }
  }, 1000);
});

// =============================================================================
// 5. STORAGE FUNCTIONS
// =============================================================================

function saveRecentToStorage() {
    localStorage.setItem('pdfRecentFiles', JSON.stringify(recentFiles));
}

function loadRecentFromStorage() {
    const saved = localStorage.getItem('pdfRecentFiles');
    if (saved) {
        try {
            recentFiles = JSON.parse(saved);
        } catch(e) {
            recentFiles = [];
        }
    }
}

function saveFavoritesToStorage() {
    localStorage.setItem('pdfFavoriteFiles', JSON.stringify(favoriteFiles));
}

function loadFavoritesFromStorage() {
    const saved = localStorage.getItem('pdfFavoriteFiles');
    if (saved) {
        try {
            favoriteFiles = JSON.parse(saved);
        } catch(e) {
            favoriteFiles = [];
        }
    }
}

function addToRecentFiles(fileObj) {
    const existingIndex = recentFiles.findIndex(f => f.id === fileObj.id);
    if (existingIndex > -1) {
        recentFiles.splice(existingIndex, 1);
    }
    
    recentFiles.unshift(fileObj);
    
    if (recentFiles.length > 20) {
        recentFiles = recentFiles.slice(0, 20);
    }
    
    saveRecentToStorage();
}

function toggleFavoriteInStorage(fileId, isFavorite) {
    [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
        const fileIndex = fileList.findIndex(f => f.id === fileId);
        if (fileIndex > -1) {
            fileList[fileIndex].isFavorite = isFavorite;
            fileList[fileIndex].favoriteDate = isFavorite ? new Date().toISOString() : null;
        }
    });

    if (isFavorite) {
        let fileToAdd = null;
        [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
            const file = fileList.find(f => f.id === fileId);
            if (file && !fileToAdd) {
                fileToAdd = {...file};
            }
        });
        
        if (fileToAdd) {
            const existingIndex = favoriteFiles.findIndex(f => f.id === fileId);
            if (existingIndex > -1) {
                favoriteFiles.splice(existingIndex, 1);
            }
            
            favoriteFiles.unshift(fileToAdd);
        }
    } else {
        favoriteFiles = favoriteFiles.filter(f => f.id !== fileId);
    }
    
    saveFavoritesToStorage();
    saveRecentToStorage();
    loadData();
}

// =============================================================================
// 6. LOAD DATA & RENDER
// =============================================================================

function loadData() {
  const sortedRecent = [...recentFiles].sort((a, b) => {
      return new Date(b.lastOpened || b.openedDate || 0) - new Date(a.lastOpened || a.openedDate || 0);
  });
  renderList('recentList', sortedRecent, 'recent');
  
  const sortedFavorites = [...favoriteFiles].sort((a, b) => {
      return new Date(b.favoriteDate || 0) - new Date(a.favoriteDate || 0);
  });
  renderList('favoritesList', sortedFavorites, 'favorites');
  
  // Cihaz PDF'lerini unique hale getir (path'e gÃ¶re)
  const uniqueDevicePDFs = [];
  const seenPaths = new Set();
  
  devicePDFs.forEach(pdf => {
    if (pdf.fullPath && !seenPaths.has(pdf.fullPath)) {
      seenPaths.add(pdf.fullPath);
      uniqueDevicePDFs.push(pdf);
    } else if (!pdf.fullPath) {
      uniqueDevicePDFs.push(pdf);
    }
  });
  
  const allDeviceFiles = [...uniqueDevicePDFs, ...importedFiles.filter(f => !f.path || !f.path.startsWith('/'))];
  renderList('deviceList', allDeviceFiles, 'device');
  
  checkPermissionAndUpdateUI();
}

function renderList(listId, files, listType) {
    const list = document.getElementById(listId);
    if (files.length === 0) {
        let message = "HenÃ¼z dosya yok.";
        if (listType === 'favorites') message = "HenÃ¼z favori dosya yok.";
        if (listType === 'device') message = "Cihazda PDF bulunamadÄ±.";
        
        list.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon material-symbols-rounded">${listType === 'favorites' ? 'star' : 'folder_open'}</div>
            <p>${message}</p>
        </div>`;
    } else {
        let html = '';
        files.forEach(file => {
            const metaText = getMetaText(file, listType);
            html += createCard(file.name, file.size, metaText, file.isFavorite, file.id, listType, file.filePath || file.fullPath);
        });
        list.innerHTML = html;
        attachLongPressEvents();
    }
}

function getMetaText(file, listType) {
    if (listType === 'recent') {
        if (file.lastOpened) {
            const date = new Date(file.lastOpened);
            const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            return `${file.size} â€¢ ${dateStr} â€¢ ${timeStr}`;
        } else if (file.openedDate) {
            const date = new Date(file.openedDate);
            const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            return `${file.size} â€¢ ${dateStr} â€¢ ${timeStr}`;
        }
    }
    
    if (listType === 'device') {
        if (file.uploadDate) {
            const date = new Date(file.uploadDate);
            const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            return `${file.size} â€¢ ${dateStr}`;
        }
        
        return `${file.size} â€¢ ${file.date || 'Bilinmeyen tarih'}`;
    }
    
    if (file.uploadDate) {
        const date = new Date(file.uploadDate);
        const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
        return `${file.size} â€¢ ${dateStr}`;
    }
    
    return `${file.size} â€¢ ${file.date || 'Bilinmeyen tarih'}`;
}

function createCard(name, size, meta, isFavorite, id, listType, filePath = null) {
  const MAX_LENGTH = 30;
  const truncatedName = name.length > MAX_LENGTH 
      ? name.substring(0, MAX_LENGTH) + '...' 
      : name;

  const theme = document.documentElement.getAttribute('data-theme');
  const bgColor = theme === 'dark' ? 'var(--pdf-color-bg)' : '#E53935';
  const textColor = theme === 'dark' ? 'var(--pdf-color-text)' : '#E53935';
  const fillStar = isFavorite ? 1 : 0;
  
  // Dosya konumu iÃ§in kÄ±saltÄ±lmÄ±ÅŸ path
  let fileLocation = '';
  if (listType === 'device' && filePath) {
    const pathParts = filePath.split('/');
    if (pathParts.length > 2) {
      const folderName = pathParts[pathParts.length - 2];
      fileLocation = `ðŸ“ ${folderName}`;
    }
  }

  const pdfIconSvg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 64 64">
      <rect x="0" y="0" width="64" height="64" rx="10" fill="${bgColor}"/>
      <path d="M18 12h22l10 10v30a4 4 0 0 1-4 4H18a4 4 0 0 1-4-4V16a4 4 0 0 1 4-4z"
            fill="#FFFFFF"/>
      <polygon points="40,12 50,22 40,22" fill="#F0F0F0"/>
      <rect x="22" y="24" width="18" height="3" rx="1.5" fill="${textColor}"/>
      <rect x="22" y="30" width="20" height="3" rx="1.5" fill="${textColor}"/>
      <rect x="22" y="36" width="20" height="3" rx="1.5" fill="${textColor}"/>
      <text x="50%" y="52" text-anchor="middle"
            font-family="Segoe UI, Roboto, Arial, sans-serif"
            font-weight="700" font-size="14" fill="${textColor}">
        PDF
      </text>
    </svg>
  `;

  return `
  <div class="card" 
       data-name="${name}" 
       data-size="${size}" 
       data-meta="${meta}"
       data-favorite="${isFavorite ? 'true' : 'false'}"
       data-id="${id}"
       data-list-type="${listType}"
       data-file-path="${filePath || ''}"
       onclick="handleCardClick(this, '${name}', ${id})">
    
    <div class="selection-checkbox" onclick="event.stopPropagation(); toggleCardSelection(${id})"></div>
    
    <div class="card-icon-svg-wrapper">
        ${pdfIconSvg}
    </div>
    <div class="card-details">
        <h3 class="card-title">${truncatedName}</h3>
        <div class="card-meta">${meta}</div>
        ${fileLocation ? `<div class="card-meta" style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">${fileLocation}</div>` : ''}
    </div>
    <div class="card-actions">
        <button class="icon-button favorite-btn" 
                data-fill="${fillStar}"
                onclick="event.stopPropagation(); toggleFavorite(this, ${id})">
            <span class="material-symbols-rounded" style="font-variation-settings: 'FILL' ${fillStar}, 'wght' 500, 'GRAD' 0, 'opsz' 24;">star</span>
        </button>
        <button class="icon-button more-btn" 
                onclick="event.stopPropagation(); openContextMenu('${name}', '${size}', '${meta}', ${id})">
            <span class="material-symbols-rounded">more_vert</span>
        </button>
    </div>
  </div>`;
}

// =============================================================================
// 7. FILE HANDLING - INDEXEDDB
// =============================================================================

async function handleFileSelect(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type !== 'application/pdf') {
                console.log(`${file.name} bir PDF dosyasÄ± deÄŸil!`);
                continue;
            }
            
            const now = new Date();
            const formattedDate = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
            const sizeInMB = file.size / (1024 * 1024);
            
            console.log(`ðŸ“„ PDF kaydediliyor: ${file.name} (${sizeInMB.toFixed(2)} MB)`);
            
            const result = await pdfManager.savePdfToIndexedDB(file);
            
            if (result.success) {
                const newFile = {
                    name: result.name,
                    size: formatBytes(file.size),
                    date: formattedDate,
                    uploadDate: now.toISOString(),
                    isFavorite: false,
                    id: Date.now() + i,
                    source: 'imported',
                    indexedDBSaved: true,
                    method: 'indexeddb'
                };

                importedFiles.unshift(newFile);
                
                addToRecentFiles({
                    ...newFile,
                    openedDate: now.toISOString()
                });
                
                if (currentNav !== 'home') {
                    switchNav('home');
                }
                
                switchTab('recent', true);
                loadData();
                
                const storageInfo = await pdfManager.getStorageInfo();
                if (storageInfo) {
                    console.log(`ðŸ’¾ Storage kullanÄ±mÄ±: ${storageInfo.usedMB} MB / ${storageInfo.quotaMB} MB`);
                }
                
                console.log(`âœ… PDF baÅŸarÄ±yla IndexedDB'ye kaydedildi: ${result.name}`);
            } else {
                console.error("âŒ PDF kaydedilemedi:", result.error);
                alert(`PDF kaydedilemedi: ${result.error}`);
            }
        }
        
        pdfFileInput.value = '';
    }
}

async function handleCardClick(element, name, cardId) {
    if (isSelectionMode) {
        toggleCardSelection(cardId);
        return;
    }
    
    if (!isLongPress) {
        let fileData = recentFiles.find(f => f.id === cardId) || 
                       importedFiles.find(f => f.id === cardId) || 
                       devicePDFs.find(f => f.id === cardId);

        if (fileData) {
            fileData.lastOpened = new Date().toISOString();
                
            addToRecentFiles({
                ...fileData,
                openedDate: new Date().toISOString(),
                lastOpened: new Date().toISOString()
            });
            
            await openPdfFile(fileData, name);
        } else {
            console.log("âŒ Dosya bulunamadÄ±!");
        }
    }
}

async function openPdfFile(fileData, name) {
    const pdfName = name || fileData.name || "belge.pdf";
    
    try {
        if (fileData.source === 'imported' && fileData.indexedDBSaved === true) {
            console.log("ðŸ“‚ PDF IndexedDB'den aÃ§Ä±lÄ±yor...");
            
            const pdfUrl = await pdfManager.getCurrentPdfUrl();
            
            if (pdfUrl) {
                sessionStorage.setItem('currentPdfBlobUrl', pdfUrl);
                sessionStorage.setItem('currentPdfName', pdfName);
                sessionStorage.setItem('usingIndexedDB', 'true');
                
                localStorage.setItem('lastPdfBlobUrl', pdfUrl);
                localStorage.setItem('lastPdfName', pdfName);
                localStorage.setItem('lastPdfMethod', 'indexeddb');
                
                console.log("âœ… PDF bilgileri kaydedildi:");
                console.log("  - Blob URL:", pdfUrl.substring(0, 50) + "...");
                console.log("  - PDF AdÄ±:", pdfName);
                console.log("  - Method: IndexedDB");
                
                setTimeout(() => {
                    window.location.href = 'viewer.html';
                }, 100);
            } else {
                console.error("âŒ IndexedDB'den PDF alÄ±namadÄ±");
                alert("PDF aÃ§Ä±lamadÄ±. LÃ¼tfen tekrar deneyin.");
            }
        }
        else if (fileData.source === 'device' && fileData.fullPath) {
            if (typeof window.flutter_inappwebview !== 'undefined') {
                try {
                    console.log("ðŸ“‚ Cihaz dosyasÄ± aÃ§Ä±lÄ±yor...");
                    
                    const tempPath = await window.flutter_inappwebview.callHandler('getPdfPath', fileData.fullPath, pdfName);
                    
                    if (tempPath) {
                        const pdfBytes = await window.flutter_inappwebview.callHandler('readPdfFile', tempPath);
                        
                        if (pdfBytes) {
                            const blob = new Blob([new Uint8Array(pdfBytes)], { type: 'application/pdf' });
                            const file = new File([blob], pdfName, { type: 'application/pdf' });
                            
                            const result = await pdfManager.savePdfToIndexedDB(file, pdfName, fileData.fullPath);
                            
                            if (result.success) {
                                const pdfUrl = await pdfManager.getCurrentPdfUrl();
                                
                                sessionStorage.setItem('currentPdfBlobUrl', pdfUrl);
                                sessionStorage.setItem('currentPdfName', pdfName);
                                sessionStorage.setItem('usingIndexedDB', 'true');
                                
                                localStorage.setItem('lastPdfBlobUrl', pdfUrl);
                                localStorage.setItem('lastPdfName', pdfName);
                                localStorage.setItem('lastPdfMethod', 'indexeddb');
                                
                                console.log("âœ… Cihaz dosyasÄ± IndexedDB'ye kaydedildi, viewer aÃ§Ä±lÄ±yor...");
                                
                                setTimeout(() => {
                                    window.location.href = 'viewer.html';
                                }, 100);
                            } else {
                                console.error("âŒ Dosya IndexedDB'ye kaydedilemedi");
                                alert("PDF aÃ§Ä±lamadÄ±. LÃ¼tfen tekrar deneyin.");
                            }
                        } else {
                            console.error("âŒ Dosya okunamadÄ±!");
                            alert("PDF dosyasÄ± aÃ§Ä±lamadÄ±. LÃ¼tfen tekrar deneyin.");
                        }
                    } else {
                        console.error("âŒ Temp path alÄ±namadÄ±!");
                        alert("PDF dosyasÄ± aÃ§Ä±lamadÄ±.");
                    }
                } catch (e) {
                    console.error("âŒ Dosya okuma hatasÄ±:", e);
                    alert("PDF aÃ§Ä±lÄ±rken hata oluÅŸtu: " + e.message);
                }
            } else {
                console.error("âŒ Flutter bridge bulunamadÄ±!");
                alert("Flutter bridge mevcut deÄŸil.");
            }
        } else {
            console.error("âŒ Desteklenmeyen dosya kaynaÄŸÄ±");
            alert("Bu dosya tÃ¼rÃ¼ desteklenmiyor.");
        }
    } catch (error) {
        console.error("âŒ PDF aÃ§ma hatasÄ±:", error);
        alert("PDF aÃ§Ä±lÄ±rken hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
    }
}

function formatBytes(bytes, decimals = 1) {
    if (!+bytes) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

// =============================================================================
// 8. PERMISSION FUNCTIONS - GÃœNCELLENDÄ° (DOÄžRUDAN AYARLARA)
// =============================================================================

function showPermissionModal() {
    permissionModalOverlay.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closePermissionModal() {
    permissionModalOverlay.classList.remove('show');
    document.body.style.overflow = '';
}

function openSettingsForPermission() {
    closePermissionModal();
    
    console.log("ðŸ”§ DOÄžRUDAN DOSYA ERÄ°ÅžÄ°MÄ° AYARLARI AÃ‡ILIYOR...");
    
    // Android iÃ§in doÄŸrudan dosya eriÅŸim izni sayfasÄ±na yÃ¶nlendir
    if (typeof window.flutter_inappwebview !== 'undefined') {
        window.flutter_inappwebview.callHandler('openFileAccessSettings');
    } else if (typeof Android !== 'undefined' && Android.openFileAccessSettings) {
        Android.openFileAccessSettings();
    } else {
        // WebView iÃ§in intent
        try {
            const intentUri = 'intent:#Intent;action=android.settings.MANAGE_APP_ALL_FILES_ACCESS_PERMISSION;package=com.android.settings;end';
            window.location.href = intentUri;
        } catch (e) {
            console.error("âŒ Intent aÃ§Ä±lamadÄ±:", e);
            alert("LÃ¼tfen cihaz ayarlarÄ±ndan dosya eriÅŸim izni verin.");
        }
    }
    
    // 2 saniye sonra izni kontrol et
    setTimeout(async () => {
        const hasPermission = await checkAndroidPermission();
        if (hasPermission) {
            scanDeviceForPDFs();
        }
    }, 2000);
}

function requestStoragePermission() {
    showPermissionModal();
}

async function scanDeviceForPDFs() {
    try {
        const hasPermission = await checkAndroidPermission();
        
        if (!hasPermission) {
            checkPermissionAndUpdateUI();
            return;
        }
        
        let pdfFiles = [];
        if (typeof window.flutter_inappwebview !== 'undefined') {
            try {
                const jsonResult = await window.flutter_inappwebview.callHandler('listPdfFiles');
                if (jsonResult) {
                    pdfFiles = JSON.parse(jsonResult);
                }
            } catch (e) {
                console.error('PDF listesi alÄ±namadÄ±:', e);
            }
        }
        
        devicePDFs = [];
        let nextId = 1000;
        const seenPaths = new Set();
        
        for (const fileInfo of pdfFiles) {
            // AynÄ± path'teki dosyalarÄ± kontrol et
            const alreadyExists = await pdfManager.checkIfPdfExists(fileInfo.path);
            if (alreadyExists || seenPaths.has(fileInfo.path)) {
                console.log(`â­ï¸  Zaten listede: ${fileInfo.name}`);
                continue;
            }
            
            seenPaths.add(fileInfo.path);
            const sizeFormatted = fileInfo.size ? formatBytes(fileInfo.size) : '0 KB';
            const date = new Date(fileInfo.modified);
            const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            
            devicePDFs.push({
                id: nextId++,
                name: fileInfo.name,
                size: sizeFormatted,
                date: dateStr,
                uploadDate: new Date().toISOString(),
                isFavorite: false,
                path: fileInfo.path,
                fullPath: fileInfo.path,
                source: 'device',
                filePath: fileInfo.path
            });
        }
        
        checkPermissionAndUpdateUI();
        loadData();
        
    } catch (e) {
        console.error('Device scan error:', e);
        checkPermissionAndUpdateUI();
    }
}

async function checkAndroidPermission() {
    try {
        if (typeof window.flutter_inappwebview !== 'undefined') {
            return await window.flutter_inappwebview.callHandler('checkStoragePermission');
        }
        return false;
    } catch (e) {
        console.error('Permission check error:', e);
        return false;
    }
}

async function checkPermissionAndUpdateUI() {
    const hasPermission = await checkAndroidPermission();
    const permissionContainer = document.getElementById('permissionContainer');
    const deviceList = document.getElementById('deviceList');
    
    if (!hasPermission) {
        if (permissionContainer) permissionContainer.style.display = 'block';
        if (deviceList) deviceList.style.display = 'none';
    } else {
        if (permissionContainer) permissionContainer.style.display = 'none';
        if (deviceList) deviceList.style.display = 'grid';
    }
}

// =============================================================================
// 9. SELECTION MODE - GÃœNCELLENDÄ° (UZUN BASMA Ä°YÄ°LEÅžTÄ°RMESÄ°)
// =============================================================================

function enterSelectionMode() {
    isSelectionMode = true;
    document.body.classList.add('selection-mode');
    updateSelectionCount();
}

function exitSelectionMode() {
    isSelectionMode = false;
    document.body.classList.remove('selection-mode');
    selectedCards.clear();
    document.querySelectorAll('.selection-checkbox').forEach(cb => {
        cb.classList.remove('selected');
    });
    document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('selected');
    });
}

function toggleCardSelection(cardId) {
    if (!isSelectionMode) {
        enterSelectionMode();
    }
    
    const card = document.querySelector(`.card[data-id="${cardId}"]`);
    const checkbox = card.querySelector('.selection-checkbox');
    
    if (selectedCards.has(cardId)) {
        selectedCards.delete(cardId);
        checkbox.classList.remove('selected');
        card.classList.remove('selected');
    } else {
        selectedCards.add(cardId);
        checkbox.classList.add('selected');
        card.classList.add('selected');
    }
    
    updateSelectionCount();
    
    if (selectedCards.size === 0) {
        exitSelectionMode();
    }
}

function selectAllCards() {
    const allCards = document.querySelectorAll('.card:not(.hidden)');
    allCards.forEach(card => {
        const cardId = parseInt(card.dataset.id);
        selectedCards.add(cardId);
        const checkbox = card.querySelector('.selection-checkbox');
        checkbox.classList.add('selected');
        card.classList.add('selected');
    });
    updateSelectionCount();
}

function deselectAllCards() {
    selectedCards.clear();
    document.querySelectorAll('.selection-checkbox').forEach(cb => {
        cb.classList.remove('selected');
    });
    document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('selected');
    });
    updateSelectionCount();
}

async function shareSelectedCards() {
    if (selectedCards.size === 0) {
        console.log('LÃ¼tfen paylaÅŸmak iÃ§in Ã¶ÄŸe seÃ§in.');
        return;
    }
    
    const selectedFiles = [];
    selectedCards.forEach(cardId => {
        let file = null;
        [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
            const found = fileList.find(f => f.id === cardId);
            if (found && !file) file = found;
        });
        if (file) selectedFiles.push(file);
    });
    
    if (selectedFiles.length > 0) {
        if (typeof window.flutter_inappwebview !== 'undefined') {
            for (const file of selectedFiles) {
                try {
                    let base64Data = null;
                    
                    if (file.source === 'imported' && file.indexedDBSaved) {
                        const blob = await pdfManager.getPdfFromIndexedDB(file.name);
                        if (blob) {
                            base64Data = await blobToBase64(blob);
                        }
                    } else if (file.source === 'device' && file.fullPath) {
                        const tempPath = await window.flutter_inappwebview.callHandler('getPdfPath', file.fullPath, file.name);
                        if (tempPath) {
                            const pdfBytes = await window.flutter_inappwebview.callHandler('readPdfFile', tempPath);
                            if (pdfBytes) {
                                const blob = new Blob([new Uint8Array(pdfBytes)], { type: 'application/pdf' });
                                base64Data = await blobToBase64(blob);
                            }
                        }
                    }
                    
                    if (base64Data) {
                        await window.flutter_inappwebview.callHandler('sharePdfBase64', base64Data, file.name);
                        console.log(`âœ… ${file.name} paylaÅŸÄ±ldÄ±`);
                    }
                } catch (e) {
                    console.error(`âŒ ${file.name} paylaÅŸma hatasÄ±:`, e);
                }
            }
        } else {
            console.log(`${selectedFiles.length} dosya paylaÅŸÄ±m iÃ§in hazÄ±rlandÄ±.`);
        }
    }
}

async function printSelectedCards() {
    if (selectedCards.size === 0) {
        console.log('LÃ¼tfen yazdÄ±rmak iÃ§in Ã¶ÄŸe seÃ§in.');
        return;
    }
    
    const selectedFiles = [];
    selectedCards.forEach(cardId => {
        let file = null;
        [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
            const found = fileList.find(f => f.id === cardId);
            if (found && !file) file = found;
        });
        if (file) selectedFiles.push(file);
    });
    
    if (selectedFiles.length > 0) {
        if (typeof window.flutter_inappwebview !== 'undefined') {
            for (const file of selectedFiles) {
                try {
                    let base64Data = null;
                    
                    if (file.source === 'imported' && file.indexedDBSaved) {
                        const blob = await pdfManager.getPdfFromIndexedDB(file.name);
                        if (blob) {
                            base64Data = await blobToBase64(blob);
                        }
                    } else if (file.source === 'device' && file.fullPath) {
                        const tempPath = await window.flutter_inappwebview.callHandler('getPdfPath', file.fullPath, file.name);
                        if (tempPath) {
                            const pdfBytes = await window.flutter_inappwebview.callHandler('readPdfFile', tempPath);
                            if (pdfBytes) {
                                const blob = new Blob([new Uint8Array(pdfBytes)], { type: 'application/pdf' });
                                base64Data = await blobToBase64(blob);
                            }
                        }
                    }
                    
                    if (base64Data) {
                        await window.flutter_inappwebview.callHandler('printPdfBase64', base64Data, file.name);
                        console.log(`âœ… ${file.name} yazdÄ±rÄ±ldÄ±`);
                    }
                } catch (e) {
                    console.error(`âŒ ${file.name} yazdÄ±rma hatasÄ±:`, e);
                }
            }
        } else {
            console.log(`${selectedFiles.length} dosya yazdÄ±rma iÃ§in hazÄ±rlandÄ±.`);
        }
    }
}

function deleteSelectedCards() {
    if (selectedCards.size === 0) {
        console.log('LÃ¼tfen silmek iÃ§in Ã¶ÄŸe seÃ§in.');
        return;
    }
    
    if (confirm(`${selectedCards.size} Ã¶ÄŸe silinecek. Emin misiniz?`)) {
        selectedCards.forEach(cardId => {
            recentFiles = recentFiles.filter(file => file.id !== cardId);
            importedFiles = importedFiles.filter(file => file.id !== cardId);
            devicePDFs = devicePDFs.filter(file => file.id !== cardId);
            favoriteFiles = favoriteFiles.filter(file => file.id !== cardId);
        });
        
        saveRecentToStorage();
        saveFavoritesToStorage();
        exitSelectionMode();
        loadData();
    }
}

function updateSelectionCount() {
    selectionCount.textContent = `${selectedCards.size} Ã¶ÄŸe seÃ§ildi`;
}

// =============================================================================
// 10. FAVORITE
// =============================================================================

function toggleFavorite(button, cardId) {
    if (isSelectionMode) {
        toggleCardSelection(cardId);
        return;
    }
    
    const span = button.querySelector('.material-symbols-rounded');
    const card = button.closest('.card');
    let isFavorite = card.dataset.favorite === 'true';

    isFavorite = !isFavorite;
    card.dataset.favorite = isFavorite;
    
    const fillValue = isFavorite ? 1 : 0;
    span.style.fontVariationSettings = `'FILL' ${fillValue}, 'wght' 500, 'GRAD' 0, 'opsz' 24`;

    toggleFavoriteInStorage(cardId, isFavorite);
}

// =============================================================================
// 11. LONG PRESS - GÃœNCELLENDÄ° (KARARLI BASMA)
// =============================================================================

let longPressTimer;
let isLongPress = false;
let touchStartTime = 0;
let touchStartX = 0;
let touchStartY = 0;

function attachLongPressEvents() {
    const cards = document.querySelectorAll('.card');
    
    cards.forEach(card => {
        // Touch start - basma baÅŸlangÄ±cÄ±
        card.addEventListener('touchstart', (e) => {
            if (e.target.closest('.icon-button')) {
                clearTimeout(longPressTimer);
                return;
            }
            
            touchStartTime = Date.now();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isLongPress = false;
            
            longPressTimer = setTimeout(() => {
                // Uzun basma algÄ±landÄ±
                isLongPress = true;
                if (navigator.vibrate) navigator.vibrate(50);
                
                const cardId = parseInt(card.dataset.id);
                toggleCardSelection(cardId);
            }, 500); // 500ms uzun basma sÃ¼resi
        }, {passive: true});

        // Touch move - parmak hareket ederse
        card.addEventListener('touchmove', (e) => {
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const moveThreshold = 10;
            
            // Parmak Ã§ok hareket ederse uzun basmayÄ± iptal et
            if (Math.abs(currentX - touchStartX) > moveThreshold || 
                Math.abs(currentY - touchStartY) > moveThreshold) {
                clearTimeout(longPressTimer);
            }
        });

        // Touch end - basma bitti
        card.addEventListener('touchend', () => {
            const touchDuration = Date.now() - touchStartTime;
            
            // EÄŸer uzun basma algÄ±landÄ±ysa, normal tÄ±klama iÅŸlemini engelle
            if (isLongPress) {
                isLongPress = false;
                return;
            }
            
            // KÄ±sa basma ise timer'Ä± temizle
            clearTimeout(longPressTimer);
            
            // 200ms'den kÄ±sa basma normal tÄ±klamadÄ±r
            if (touchDuration < 200) {
                isLongPress = false;
            }
        });
        
        // Touch cancel - basma iptal edildi
        card.addEventListener('touchcancel', () => {
            clearTimeout(longPressTimer);
            isLongPress = false;
        });
    });
}

// =============================================================================
// 12. CONTEXT MENU
// =============================================================================

function openContextMenu(name, size, meta, cardId) {
    if (isSelectionMode) {
        toggleCardSelection(cardId);
        return;
    }
    
    currentContextFile = { name, cardId, size, meta };
    contextTitle.textContent = name;
    contextMeta.textContent = `${size} â€¢ ${meta.split(' â€¢ ')[1] || meta}`;
    
    contextOverlay.classList.add('show');
    contextSheet.classList.add('show');
}

function closeContextMenu() {
    contextOverlay.classList.remove('show');
    contextSheet.classList.remove('show');
}

async function handleContextAction(action) {
    closeContextMenu();
    
    await new Promise(resolve => setTimeout(resolve, 300));
    
    const cardId = currentContextFile.cardId;
    const name = currentContextFile.name;
    
    switch(action) {
        case 'rename':
            const newName = prompt(`"${name}" iÃ§in yeni ad girin:`, name);
            if (newName && newName.trim() && newName !== name) {
                [recentFiles, importedFiles, devicePDFs, favoriteFiles].forEach(fileList => {
                    const fileIndex = fileList.findIndex(f => f.id === cardId);
                    if (fileIndex > -1) {
                        fileList[fileIndex].name = newName.trim();
                    }
                });
                
                saveRecentToStorage();
                saveFavoritesToStorage();
                loadData();
            }
            break;
            
        case 'share':
            let fileToShare = null;
            [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
                const file = fileList.find(f => f.id === cardId);
                if (file && !fileToShare) fileToShare = file;
            });
            
            if (fileToShare && typeof window.flutter_inappwebview !== 'undefined') {
                try {
                    let base64Data = null;
                    
                    if (fileToShare.source === 'imported' && fileToShare.indexedDBSaved) {
                        const blob = await pdfManager.getPdfFromIndexedDB(fileToShare.name);
                        if (blob) {
                            base64Data = await blobToBase64(blob);
                        }
                    } else if (fileToShare.source === 'device' && fileToShare.fullPath) {
                        const tempPath = await window.flutter_inappwebview.callHandler('getPdfPath', fileToShare.fullPath, fileToShare.name);
                        if (tempPath) {
                            const pdfBytes = await window.flutter_inappwebview.callHandler('readPdfFile', tempPath);
                            if (pdfBytes) {
                                const blob = new Blob([new Uint8Array(pdfBytes)], { type: 'application/pdf' });
                                base64Data = await blobToBase64(blob);
                            }
                        }
                    }
                    
                    if (base64Data) {
                        await window.flutter_inappwebview.callHandler('sharePdfBase64', base64Data, fileToShare.name);
                        console.log(`âœ… ${fileToShare.name} paylaÅŸÄ±ldÄ±`);
                    }
                } catch (e) {
                    console.error('âŒ PaylaÅŸma hatasÄ±:', e);
                }
            }
            break;
            
        case 'print':
            let fileToPrint = null;
            [recentFiles, importedFiles, devicePDFs].forEach(fileList => {
                const file = fileList.find(f => f.id === cardId);
                if (file && !fileToPrint) fileToPrint = file;
            });
            
            if (fileToPrint && typeof window.flutter_inappwebview !== 'undefined') {
                try {
                    let base64Data = null;
                    
                    if (fileToPrint.source === 'imported' && fileToPrint.indexedDBSaved) {
                        const blob = await pdfManager.getPdfFromIndexedDB(fileToPrint.name);
                        if (blob) {
                            base64Data = await blobToBase64(blob);
                        }
                    } else if (fileToPrint.source === 'device' && fileToPrint.fullPath) {
                        const tempPath = await window.flutter_inappwebview.callHandler('getPdfPath', fileToPrint.fullPath, fileToPrint.name);
                        if (tempPath) {
                            const pdfBytes = await window.flutter_inappwebview.callHandler('readPdfFile', tempPath);
                            if (pdfBytes) {
                                const blob = new Blob([new Uint8Array(pdfBytes)], { type: 'application/pdf' });
                                base64Data = await blobToBase64(blob);
                            }
                        }
                    }
                    
                    if (base64Data) {
                        await window.flutter_inappwebview.callHandler('printPdfBase64', base64Data, fileToPrint.name);
                        console.log(`âœ… ${fileToPrint.name} yazdÄ±rÄ±ldÄ±`);
                    }
                } catch (e) {
                    console.error('âŒ YazdÄ±rma hatasÄ±:', e);
                }
            }
            break;
            
        case 'delete':
            if(confirm(`"${name}" dosyasÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
                recentFiles = recentFiles.filter(f => f.id !== cardId);
                importedFiles = importedFiles.filter(f => f.id !== cardId);
                devicePDFs = devicePDFs.filter(f => f.id !== cardId);
                favoriteFiles = favoriteFiles.filter(f => f.id !== cardId);
                
                saveRecentToStorage();
                saveFavoritesToStorage();
                loadData();
            }
            break;
    }
}

// =============================================================================
// 13. HELPER: BLOB TO BASE64
// =============================================================================

async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// =============================================================================
// 14. SEARCH
// =============================================================================

function triggerSearch() {
    const query = searchInput.value.toLowerCase().trim();
    const allCards = document.querySelectorAll('.card');
    let visibleCount = 0;
    
    allCards.forEach(card => {
        const title = card.querySelector('.card-title').innerText.toLowerCase();
        const meta = card.querySelector('.card-meta').innerText.toLowerCase();
        
        if (query === '' || title.includes(query) || meta.includes(query)) {
            card.classList.remove('hidden');
            visibleCount++;
        } else {
            card.classList.add('hidden');
        }
    });
    
    const activePanel = document.querySelector('.content-panel.active');
    const existingEmptyState = activePanel.querySelector('.search-empty-state');
    if (existingEmptyState) existingEmptyState.remove();
    
    if (visibleCount === 0 && query !== '') {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state search-empty-state';
        emptyState.innerHTML = `
            <div class="empty-icon material-symbols-rounded">search</div>
            <p>"${query}" iÃ§in sonuÃ§ bulunamadÄ±</p>
        `;
        activePanel.appendChild(emptyState);
    }
}

// =============================================================================
// 15. TOOLS
// =============================================================================

function loadTools() {
  const toolsGrid = document.getElementById('toolsGrid');
  if (!toolsGrid) return;
  
  let html = '';
  toolsData.forEach(tool => {
    html += `
      <div class="tool-card" onclick="openToolPage('${tool.page}')">
        <div class="tool-icon-wrapper" style="background: ${tool.color}20; color: ${tool.color};">
          <span class="material-symbols-rounded">${tool.iconCode}</span>
        </div>
        <div class="tool-title">${tool.title}</div>
      </div>
    `;
  });
  
  toolsGrid.innerHTML = html;
}

function openToolPage(page) {
  window.location.href = page;
}

// =============================================================================
// 16. EVENTS
// =============================================================================

function attachEvents() {
    
    contextOverlay.addEventListener('click', closeContextMenu);
    
    permissionModalOverlay.addEventListener('click', function(e) {
        if (e.target === permissionModalOverlay) {
            closePermissionModal();
        }
    });

    searchBtn.addEventListener('click', () => {
        document.body.classList.add('is-searching');
        
        headerNormal.classList.add('hidden');
        searchBar.classList.add('active');
        searchInput.focus();

        if (currentNav !== 'home') {
            switchNav('home');
        }
        
        triggerSearch();
    });

    closeSearchBtn.addEventListener('click', () => {
        document.body.classList.remove('is-searching');

        searchBar.classList.remove('active');
        headerNormal.classList.remove('hidden');
        searchInput.value = '';
        
        document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('hidden');
        });
        
        document.querySelectorAll('.search-empty-state').forEach(el => el.remove());
        
        triggerSearch();
    });

    searchInput.addEventListener('input', triggerSearch);

    panels.forEach(panel => {
        panel.addEventListener('scroll', (e) => {
            if (document.body.classList.contains('is-searching')) return;

            if(currentNav !== 'home' || !panel.classList.contains('active')) return;
            const currentY = e.target.scrollTop;
            const direction = currentY > lastScrollY ? 'down' : 'up';
            
            if(currentY > 10 && direction === 'down') {
                topBar.style.transform = `translateY(-${headerHeight}px)`;
            } else if (direction === 'up') {
                topBar.style.transform = 'translateY(0)';
            }
            lastScrollY = currentY;
        });
    });

    panels.forEach(panel => {
        panel.addEventListener('touchstart', e => {
            if (document.body.classList.contains('is-searching')) return;

            if(currentNav !== 'home' || !panel.classList.contains('active')) return;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isSwiping = false;
            isVerticalScroll = false;
        }, {passive: false});

        panel.addEventListener('touchmove', e => {
            if (document.body.classList.contains('is-searching')) return;

            if(currentNav !== 'home' || !panel.classList.contains('active')) return;
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = currentX - startX;
            const diffY = currentY - startY;
            const moveThreshold = 10;
            
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > moveThreshold) {
                e.preventDefault();
                isSwiping = true;
                isVerticalScroll = false;
            } else if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > moveThreshold) {
                isSwiping = false;
                isVerticalScroll = true;
            }
        }, {passive: false});

        panel.addEventListener('touchend', e => {
            if (document.body.classList.contains('is-searching')) return;

            if(currentNav !== 'home' || !panel.classList.contains('active')) return;
            const endX = e.changedTouches[0].clientX;
            const diffX = endX - startX;
            const swipeThreshold = 50;

            if (isSwiping && Math.abs(diffX) > swipeThreshold) {
                changeTab(diffX < 0 ? 1 : -1);
            }
            isSwiping = false;
            isVerticalScroll = false;
        });
    });
    
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab, true)));
    navItems.forEach(n => n.addEventListener('click', () => switchNav(n.dataset.nav)));
    
    // FAB - PDF AÃ‡ Ä°ÅžLEMÄ° Ä°Ã‡Ä°N Ä°ZÄ°N MODALI
    fabButton.addEventListener('click', (e) => {
        e.stopPropagation();
        fabMenu.classList.toggle('show');
    });
    
    // PDF AÃ§ butonu iÃ§in izin kontrolÃ¼
    document.querySelector('.fab-item').addEventListener('click', (e) => {
        e.stopPropagation();
        fabMenu.classList.remove('show');
        
        // Ä°zin kontrolÃ¼ yap
        checkAndroidPermission().then(hasPermission => {
            if (hasPermission) {
                // Ä°zin varsa normal dosya seÃ§iciyi aÃ§
                pdfFileInput.click();
            } else {
                // Ä°zin yoksa izin modalÄ±nÄ± gÃ¶ster
                showPermissionModal();
            }
        });
    });
    
    document.addEventListener('click', () => fabMenu.classList.remove('show'));
    
    document.getElementById('menuBtn').addEventListener('click', () => {
        drawer.classList.add('open');
        overlay.classList.add('show');
    });
    overlay.addEventListener('click', () => {
        drawer.classList.remove('open');
        overlay.classList.remove('show');
    });
    
    drawerItems.forEach(item => {
        item.addEventListener('click', () => {
            const targetId = `accordion-${item.dataset.accordion}`;
            const targetContent = document.getElementById(targetId);
            document.querySelectorAll('.drawer-accordion-content.open').forEach(content => {
                if (content !== targetContent) {
                    content.classList.remove('open');
                }
            });
            targetContent.classList.toggle('open');
        });
    });

    settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            settingsTabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.setting-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.querySelector(`.setting-panel[data-panel="${targetTab}"]`).classList.add('active');
        });
    });
}

// =============================================================================
// 17. NAVIGATION
// =============================================================================

function switchTab(id, isClickOrNav = false) {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === id));
    
    document.querySelectorAll('#recentPanel, #favoritesPanel, #devicePanel').forEach(p => {
        p.classList.toggle('active', p.id === `${id}Panel`);
        if(p.id === `${id}Panel`) {
            if(isClickOrNav) {
                p.scrollTop = 0;
                topBar.style.transform = 'translateY(0)';
                lastScrollY = 0;
            } else {
                const currentTransform = topBar.style.transform;
                if (currentTransform === `translateY(-${headerHeight}px)`) {
                     p.scrollTop = headerHeight + 1;
                     lastScrollY = headerHeight + 1;
                } else {
                    p.scrollTop = 0;
                    lastScrollY = 0;
                }
            }
        }
    });
    
    if (id === 'device') {
        scanDeviceForPDFs();
    }
}

function changeTab(dir) {
    const active = document.querySelector('.tab.active').dataset.tab;
    const idx = tabOrder.indexOf(active);
    const nextIdx = idx + dir;
    if(nextIdx >= 0 && nextIdx < tabOrder.length) {
        switchTab(tabOrder[nextIdx], false);
    }
}

function switchNav(id) {
    if (isSelectionMode) {
        exitSelectionMode();
    }
    
    if (document.body.classList.contains('is-searching')) {
        document.body.classList.remove('is-searching');
        searchBar.classList.remove('active');
        headerNormal.classList.remove('hidden');
        searchInput.value = '';
        triggerSearch();
    }
    
    navItems.forEach(n => n.classList.toggle('active', n.dataset.nav === id));
    currentNav = id;
    
    panels.forEach(p => p.classList.remove('active'));
    topBar.style.transform = 'translateY(0)';
    lastScrollY = 0;
    fabButton.style.display = id === 'home' ? 'flex' : 'none';

    if(id === 'home') {
        topBar.classList.remove('tabs-hidden');
        mainContent.style.paddingTop = 'var(--top-bar-total)';
        switchTab('recent', true);
    } else {
        topBar.classList.add('tabs-hidden');
        mainContent.style.paddingTop = `calc(${headerHeight}px + 16px)`;
        const targetPanel = document.getElementById(`${id}Panel`);
        if (targetPanel) {
            targetPanel.classList.add('active');
            targetPanel.scrollTop = 0;
        }
    }
}

function handleFileSource(source) {
    if (source === 'device') {
        scanDeviceForPDFs();
        switchNav('home');
        switchTab('device', true);
    } else if (source === 'browse_more') {
        if (typeof Android !== 'undefined' && Android.openFileManager) {
            Android.openFileManager();
        }
    } else {
        if (typeof Android !== 'undefined') {
            switch(source) {
                case 'gdrive':
                    Android.connectGoogleDrive();
                    break;
                case 'onedrive':
                    Android.connectOneDrive();
                    break;
                case 'dropbox':
                    Android.connectDropbox();
                    break;
                case 'gmail':
                    Android.connectGmail();
                    break;
            }
        }
    }
}

function sendHelpEmail(e) {
    e.preventDefault();
    const email = document.getElementById('helpEmail').value;
    const subject = document.getElementById('helpSubject').value;
    const issue = document.getElementById('helpIssue').value;
    const recipient = "devsoftawaremail@gmail.com";
    const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent("GÃ¶nderen: " + email + "\n\nSorun:\n" + issue)}`;
    window.location.href = mailtoLink;
    document.querySelector('.help-form').reset();
}

function handleFabAction(action) {
  if (action === 'open_pdf') {
      // Ä°zin kontrolÃ¼ yap
      checkAndroidPermission().then(hasPermission => {
          if (hasPermission) {
              pdfFileInput.click();
          } else {
              showPermissionModal();
          }
      });
  }
  fabMenu.classList.remove('show');
}

// =============================================================================
// 18. ANDROID
// =============================================================================

function onAndroidResume() {
    try {
        checkPermissionAndUpdateUI();
        
        if (currentNav === 'home') {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab === 'device') {
                scanDeviceForPDFs();
            }
        }
    } catch (e) {
        console.warn('onAndroidResume error', e);
    }
}

let backPressedTime = 0;

window.androidBackPressed = function() {
    if (permissionModalOverlay.classList.contains('show')) {
        closePermissionModal();
        return false;
    }
    
    if (window.location.href.includes('viewer.html') || window.location.href.includes('iframe.html')) {
        window.location.href = 'index.html';
        return true;
    }
    
    if (isSelectionMode) {
        exitSelectionMode();
        return false;
    }
    
    if (document.body.classList.contains('is-searching')) {
        closeSearchBtn.click();
        return false;
    }
    
    if (drawer.classList.contains('open')) {
        drawer.classList.remove('open');
        overlay.classList.remove('show');
        return false;
    }
    
    if (contextSheet.classList.contains('show')) {
        closeContextMenu();
        return false;
    }
    
    if (fabMenu.classList.contains('show')) {
        fabMenu.classList.remove('show');
        return false;
    }
    
    if (currentNav !== 'home') {
        switchNav('home');
        return false;
    }
    
    const now = Date.now();
    if (backPressedTime + 2000 > now) {
        return 'exit_check';
    } else {
        backPressedTime = now;
        return false;
    }
};

// =============================================================================
// 19. GLOBAL FUNCTIONS
// =============================================================================

window.sendHelpEmail = sendHelpEmail;
window.handleFileSource = handleFileSource;
window.handleFabAction = handleFabAction;
window.triggerSearch = triggerSearch;
window.openContextMenu = openContextMenu;
window.handleContextAction = handleContextAction;
window.handleCardClick = handleCardClick;
window.toggleFavorite = toggleFavorite;
window.enterSelectionMode = enterSelectionMode;
window.exitSelectionMode = exitSelectionMode;
window.toggleCardSelection = toggleCardSelection;
window.selectAllCards = selectAllCards;
window.deselectAllCards = deselectAllCards;
window.deleteSelectedCards = deleteSelectedCards;
window.shareSelectedCards = shareSelectedCards;
window.printSelectedCards = printSelectedCards;
window.handleFileSelect = handleFileSelect;
window.scanDeviceForPDFs = scanDeviceForPDFs;
window.onAndroidResume = onAndroidResume;
window.openToolPage = openToolPage;
window.requestStoragePermission = requestStoragePermission;
window.showPermissionModal = showPermissionModal;
window.closePermissionModal = closePermissionModal;
window.openSettingsForPermission = openSettingsForPermission;

console.log("âœ… PDF Reader - GÃ¼ncellenmiÅŸ Versiyon YÃ¼klendi");

// =============================================================================
// 20. THEME PREFERENCE
// =============================================================================

function setThemePreference(theme) {
    const themeOptions = document.querySelectorAll('.theme-option');
    themeOptions.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.themeVal === theme) {
            option.classList.add('active');
        }
    });
    
    if (theme === 'device') {
        // Cihaz temasÄ±nÄ± kullan
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', systemPrefersDark ? 'dark' : 'light');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
    
    localStorage.setItem('themePreference', theme);
}

// Sayfa yÃ¼klendiÄŸinde tema tercihini yÃ¼kle
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('themePreference');
    if (savedTheme) {
        setThemePreference(savedTheme);
    }
});




</script>



<!-- Script kismi -->

          
</body>
</html>
