<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <title>PDF Görüntüle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --safe-top: env(safe-area-inset-top); }
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; background-color: #f5f5f5; padding-top: var(--safe-top); }
        #topBar { height: 56px; display: flex; align-items: center; background-color: #fff; border-bottom: 1px solid #e0e0e0; padding: 0 8px; }
        #title { flex: 1; margin-left: 8px; font-size: 17px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .action-btn { background: none; border: none; width: 44px; height: 44px; border-radius: 50%; color: #5f6368; cursor: pointer; }
        #viewerArea { flex: 1; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
<div id="topBar">
    <button id="back" style="background:none; border:none;" onclick="goBack()"><span class="material-icons">arrow_back</span></button>
    <div id="title">Yükleniyor...</div>
    <div id="actions">
        <button id="share" class="action-btn"><span class="material-icons">share</span></button>
        <button id="print" class="action-btn"><span class="material-icons">print</span></button>
    </div>
</div>
<div id="viewerArea"><iframe id="pdfFrame"></iframe></div>

<script>
    const shareBtn = document.getElementById("share");
    const printBtn = document.getElementById("print");
    const frame = document.getElementById("pdfFrame");

    // Flutter'dan veya bir önceki sayfadan gelen veriyi al
    // Önce sessionStorage, yoksa URL parametresi (fallback)
    let pdfData = sessionStorage.getItem("pdfData");
    let pdfName = sessionStorage.getItem("pdfName") || "belge.pdf";

    document.getElementById("title").textContent = pdfName;

    // PDF.js Viewer'ı yükle
    frame.src = "web/viewer.html";

    // Flutter IframePage içinden bu fonksiyonu tetikleyeceğiz
    window.loadPdf = function() {
        pdfData = sessionStorage.getItem("pdfData");
        if(pdfData && frame.contentWindow) {
            frame.contentWindow.postMessage(pdfData, "*");
        }
    };

    frame.onload = () => {
        if(pdfData) {
            frame.contentWindow.postMessage(pdfData, "*");
        }
    };

    function goBack() {
        // Eğer Flutter içindeyse sayfayı kapat, tarayıcıdaysa geri git
        if (window.flutter_inappwebview) {
            // İstersen burada bir handler çağırabilirsin veya standart history kullanabilirsin
            history.back();
        } else {
            history.back();
        }
    }

    function sendToFlutter(action) {
        // Flutter içinde olup olmadığımızı kontrol et
        if (window.flutter_inappwebview) {
            window.flutter_inappwebview.callHandler(action, {
                pdfData: pdfData,
                pdfName: pdfName
            });
        } else {
            console.log("Tarayıcı modunda: " + action + " tetiklendi.");
            alert(action + " sadece uygulama içinde çalışır.");
        }
    }

    // Flutter AppBar'dan gelen komutları dinlemek için (Opsiyonel)
    window.requestShare = () => sendToFlutter('flutterShare');
    window.requestPrint = () => sendToFlutter('flutterPrint');

    shareBtn.onclick = () => sendToFlutter('flutterShare');
    printBtn.onclick = () => sendToFlutter('flutterPrint');
</script>
</body>
</html>
